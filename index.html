<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Monek System v6.0 - Connected</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --gold: #ffcc33;
            --dark-overlay: rgba(10, 10, 10, 0.6);
            --bg-main: url('https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/9B5D449E-418A-45D3-B788-8778649B65DC.webp');
            --bg-loader: url('https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/D89BBBDF-73C1-4649-9D84-C7B9A8A072AF.webp');
            --bg-menu: url('https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/55CB662D-41CA-47A0-B87B-097BF580D9EF.webp');
            --bg-hours: url('https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/9B5D449E-418A-45D3-B788-8778649B65DC.webp');
            --vh: 100vh;
            --safe-top: env(safe-area-inset-top, 0px);
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none;
        }

        input, select { -webkit-user-select: text; user-select: text; }

        html, body {
            width: 100%;
            height: var(--vh);
            overflow: hidden;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            position: fixed;
        }

        #fixed-bg {
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; 
            height: var(--vh);
            z-index: 0;
            background-size: 100% 100%;
            background-position: center top;
            background-repeat: no-repeat;
            pointer-events: none;
            will-change: transform;
            transition: background-image 0.5s ease-in-out;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: var(--vh);
            display: none; 
            z-index: 5; 
            overflow-y: auto;
            opacity: 0;
            transform: scale(0.96); 
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-overflow-scrolling: touch;
        }

        .screen.active {
            display: block;
            opacity: 1;
            transform: scale(1);
        }

        body.keyboard-open {
            position: relative;
            overflow: auto;
            height: auto;
        }
        body.keyboard-open .screen.active {
            position: relative;
            height: auto;
            overflow: visible;
        }

        .canvas {
            position: relative;
            width: 100%;
            min-height: 100%; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px; 
        }

        .top-logo-box { 
            position: absolute; 
            top: var(--safe-top);
            margin-top: 35px;
            width: 100%; 
            display: flex; 
            justify-content: center; 
            z-index: 5; 
            pointer-events: none; 
        }

        #menu-screen .top-logo-box { 
            top: var(--safe-top);
            margin-top: -15px; 
        } 
        
        .header-logo { 
            width: 210px; 
            height: auto;
            display: block;
        }

        @keyframes pulse-inward {
            0% { transform: scale(1); }
            50% { transform: scale(0.92); }
            100% { transform: scale(1); }
        }

        @keyframes neon-pulse {
            0% { box-shadow: 0 0 10px rgba(255, 204, 51, 0.4), 0 0 5px rgba(255, 204, 51, 0.2); }
            50% { box-shadow: 0 0 25px rgba(255, 204, 51, 0.8), 0 0 12px rgba(255, 204, 51, 0.4); }
            100% { box-shadow: 0 0 10px rgba(255, 204, 51, 0.4), 0 0 5px rgba(255, 204, 51, 0.2); }
        }

        .menu-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        
        .menu-item { 
            position: absolute; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            cursor: pointer; 
            animation: pulse-inward 3s infinite ease-in-out; 
            transition: transform 0.1s ease, filter 0.1s;
        }

        .menu-item:active {
            animation: none; 
            transform: scale(0.8) !important;
            filter: brightness(0.7);
        }

        #m-clocks, #m-top, #m-account, #m-dayoff { animation-delay: 0.5s; }

        .menu-icon { max-width: 100%; max-height: 100%; pointer-events: none; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); transition: transform 0.2s ease; }

        #img-profile  { transform: scale(2.5) translate(0px, 4px); }
        #img-clocks   { transform: scale(2.5) translate(0px, 5.5px); }
        #img-advances { transform: scale(2.5) translate(0px, 11px); }
        #img-top      { transform: scale(2.5) translate(0px, 3.5px); }
        #img-shop     { transform: scale(2.7) translate(0px, 3.5px); }
        #img-account  { transform: scale(2.9) translate(0.3px, 3.5px); }
        #img-workers  { transform: scale(2.8) translate(0px, 7.5px); }
        #img-dayoff   { transform: scale(2.5) translate(0.5px, 4.5px); }

        #m-profile  { top: 34%; left: 20.0%; width: 20%; height: 10%; }
        #m-clocks   { top: 33.5%; left: 60.5%; width: 20%; height: 10%; }
        #m-workers  { top: 47%; left: 20.0%; width: 20%; height: 10%; }
        #m-top      { top: 47%; left: 60.5%; width: 20%; height: 10%; }
        #m-advances { top: 59.5%; left: 19.5%; width: 20%; height: 10%; }
        #m-account  { top: 59.5%; left: 60%; width: 20%; height: 10%; }
        #m-shop     { top: 72.5%; left: 20.0%; width: 20%; height: 10%; }
        #m-dayoff   { top: 72.5%; left: 59.5%; width: 20%; height: 10%; }

        .loader-content { position: absolute; top: 46%; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .progress-container { width: 60%; height: 14px; background: rgba(0,0,0,0.6); border-radius: 20px; border: 2px solid rgba(255,255,255,0.4); overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ffcc33, #ff6600); }
        #loading-text { color: var(--gold); font-size: 20px; margin-top: 12px; font-weight: 900; -webkit-text-stroke: 1.2px black; text-shadow: 2px 2px 0px rgba(0,0,0,1); }

        .panel-container {
            width: 68%; background: var(--dark-overlay);
            border: 1px solid var(--gold); border-radius: 12px;
            padding: 12px; display: flex; flex-direction: column;
            align-items: center; 
            margin-bottom: 50px; z-index: 10;
            animation: neon-pulse 2.5s infinite ease-in-out;
            backdrop-filter: blur(5px);
        }

        .panel-title { 
            color: var(--gold); 
            font-weight: 900; 
            text-transform: uppercase; 
            font-size: 13px; 
            text-align: center;
            border: 1px solid var(--gold);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            width: fit-content;
            padding: 5px 15px;
            margin-top: -28px;
            background: rgba(10,10,10, 0.9);
            margin-bottom: 15px;
        }

        .panel-header-row { display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom: 10px; }
        .panel-input { width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid rgba(255,204,51,0.4); background: rgba(0,0,0,0.3); color: white; border-radius: 8px; text-align: center; }

        .input-label { color: var(--gold); font-size: 10px; align-self: flex-start; margin-left: 5px; margin-bottom: 2px; font-weight: bold; text-transform: uppercase; }

        #adv-currency {
            height: 44px;
            font-size: 14px;
            font-weight: bold;
            border: 1px solid var(--gold);
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23ffcc33' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 30px;
        }

        .btn-panel, .btn-beaut, .btn-header-action, .btn-icon-action, .btn-small, .top-tab {
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.1s;
            cursor: pointer;
        }
        
        .btn-panel:active, .btn-beaut:active, .btn-header-action:active, .btn-icon-action:active, .btn-small:active, .top-tab:active {
            transform: scale(0.88) translateY(2px) !important;
            filter: brightness(0.7) contrast(1.2);
        }

        .btn-panel { width: 100%; padding: 11px; margin-top: 6px; border-radius: 8px; font-weight: 900; text-transform: uppercase; font-size: 12px; border: none; }
        .btn-panel-gold { background: linear-gradient(180deg, #ffcc33 0%, #ff9900 100%); color: #000; }
        .btn-panel-outline { background: transparent; border: 1px solid var(--gold); color: var(--gold); }
        
        .btn-icon-action { width: 30px; height: 30px; border-radius: 4px; border: none; font-weight: 900; font-size: 16px; display: flex; align-items: center; justify-content: center; margin-left: 5px; }
        .btn-green { background: #00cc00; color: white; }
        .btn-red { background: #cc0000; color: white; }
        .btn-header-action { background: transparent; border: 1px solid var(--gold); color: var(--gold); width: 28px; height: 28px; border-radius: 50%; font-weight: 900; font-size: 16px; margin-left: 5px; display: flex; align-items: center; justify-content: center; }

        .header-controls-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            border: 1px solid var(--gold);
            padding: 5px 8px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .inner-btn-wrap {
            display: flex;
            gap: 5px;
        }
        .inner-btn-wrap .btn-header-action {
            border: 1px solid var(--gold);
            margin: 0;
        }

        .acc-panel, .shop-panel { margin-top: 30%; }
        .adv-panel { margin-top: 48%; }
        .do-panel { margin-top: 58%; }
        .profile-panel { margin-top: 30%; height: 415px; }
        .top-panel { margin-top: 30%; height: 430px; } 
        .clocks-panel { margin-top: 30%; height: 415px; } 
        .workers-panel { margin-top: 30%; height: 415px; } 
        .worker-edit-panel { margin-top: 55%; }

        .hours-unified-panel { 
            width: 68%; margin-top: 30%; background: var(--dark-overlay); 
            border: 1px solid var(--gold); border-radius: 12px; 
            overflow: visible; margin-bottom: 50px; z-index: 10;
            animation: neon-pulse 2.5s infinite ease-in-out;
            backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center;
            padding: 12px;
        }
        
        .table-scroll-container { width: 100%; height: 230px; overflow-y: auto; -webkit-overflow-scrolling: touch; } 
        .hours-table-main { width: 100%; border-collapse: collapse; color: white; font-size: 12px; }
        .hours-table-main th { position: sticky; top: 0; background: var(--gold); color: #000; padding: 10px 2px; }
        .hours-table-main td { border-bottom: 1px solid rgba(255,255,255,0.08); padding: 5px 2px; text-align: center; }
        .hour-input-cell { width: 90%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,204,51,0.2); color: white; text-align: center; padding: 4px; border-radius: 4px; }
        
        .beautiful-btns-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px 0; width: 100%; }
        .btn-beaut { padding: 10px; border-radius: 8px; font-weight: 900; font-size: 10px; border: none; text-transform: uppercase; }

        .leaderboard-box { width: 100%; flex-grow: 1; overflow-y: auto; margin-top: 10px; -webkit-overflow-scrolling: touch; }
        .leaderboard-table { width: 100%; color: white; font-size: 12px; border-collapse: separate; border-spacing: 0 8px; margin-bottom: 10px; }
        .leaderboard-table tr { background: rgba(255, 255, 255, 0.05); }
        .leaderboard-table td { 
            padding: 10px 6px; 
            text-align: center; 
            border-top: 1px solid var(--gold); 
            border-bottom: 1px solid var(--gold);
            white-space: nowrap; 
        }
        .leaderboard-table td:first-child { border-left: 1px solid var(--gold); border-radius: 8px 0 0 8px; width: 30px; }
        .leaderboard-table td:last-child { border-right: 1px solid var(--gold); border-radius: 0 8px 8px 0; text-align: right; }
        .leaderboard-table td:nth-child(2) { text-align: left; overflow: hidden; text-overflow: ellipsis; }
        
        .top-header-frame { border: 2px solid var(--gold); border-radius: 10px; width: 100%; padding: 5px; margin-bottom: 5px; }
        .top-tabs { display: flex; width: 100%; justify-content: space-between; margin-bottom: 5px; }
        .top-tab { flex: 1; border: 1px solid var(--gold); color: var(--gold); background: transparent; padding: 5px; font-size: 10px; font-weight: bold; }
        .top-tab.active { background: var(--gold); color: black; }

        .stat-row-decor { 
            background: rgba(255, 204, 51, 0.08); 
            border: 1px solid var(--gold); 
            border-radius: 6px; 
            padding: 10px; 
            margin-bottom: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            width: 100%;
        }
        .stat-row { display: flex; justify-content: space-between; width: 100%; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; color: white; align-items: center; }
        .stat-value { color: var(--gold); font-weight: bold; }

        .shop-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
            margin-bottom: 12px; 
            border: 1px solid var(--gold); 
            padding: 8px; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.02);
        }
        .shop-info { color: white; font-size: 14px; font-weight: bold; }
        .shop-subtext { font-size: 10px; color: #888; display: block; }
        .shop-qty-input { width: 70px; padding: 8px; text-align: center; border-radius: 4px; border: 1px solid var(--gold); background: rgba(0,0,0,0.5); color: white; font-weight: bold; }

        .worker-item-card {
            border: 1px solid var(--gold);
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        .worker-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .firm-item-card {
            border: 1px solid var(--gold);
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 45px;
        }

        .worker-cat-row { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 8px 0; border-bottom: 1px solid #333; color: white; font-size: 13px; }
        .calc-panel-inline { width: 100%; gap: 5px; margin-top: 5px; display: none; align-items: center; }
        .calc-panel-inline.active { display: flex; }
        .calc-input { flex: 1; padding: 5px; background: rgba(0,0,0,0.5); border: 1px solid var(--gold); color: white; border-radius: 4px; text-align: center; }
        
        .worker-actions-menu {
            display: none;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-top: 10px;
            width: 100%;
        }
        .worker-actions-menu.active { display: grid; }
        .btn-action-outline {
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
            border-radius: 4px;
            padding: 6px 2px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
        }

        #add-product-table {
            width: 100%;
            margin-bottom: 15px;
            display: none;
            border: 1px solid var(--gold);
            padding: 10px;
            border-radius: 8px;
            background: rgba(10,10,10,0.5);
        }
        
        .user-shop-title-wrapper {
            width: 100%;
            border: 1px solid var(--gold);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 12px;
            text-align: center;
        }

        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã –≤ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞—Ö */
        .workers-header-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            border: 1px solid var(--gold);
            padding: 5px 8px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .trash-btn-outer {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--gold);
            border-radius: 4px;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }
        .trash-btn-outer:active { transform: scale(0.9); }

        /* –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã —è–∑—ã–∫–∞ */
        .lang-switch-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 32px;
            height: 32px;
            background: transparent;
            border: 1px solid var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            z-index: 15;
            transition: all 0.2s;
        }
    </style>
</head>
<body onclick="hideKeyboard(event)">

    <div id="fixed-bg"></div>

    <div id="loader-screen" class="screen active" style="opacity: 1; transform: scale(1);">
        <div class="canvas">
            <div class="loader-content">
                <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
                <div id="loading-text">0%</div>
            </div>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <div class="canvas">
            <div class="top-logo-box"></div>
            <div class="menu-container">
                <div class="menu-item" id="m-profile"><img src="https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/D6D08605-797C-407A-AC9F-CA1D85241C3A.webp" class="menu-icon" id="img-profile"></div>
                <div class="menu-item" id="m-clocks"><img src="https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/8CF47A13-928B-47FC-9494-D6354E56BB25.webp" class="menu-icon" id="img-clocks"></div>
                <div class="menu-item" id="m-advances"><img src="https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/9B30F657-53D7-4158-91D6-5F004D6E3D19.webp" class="menu-icon" id="img-advances"></div>
                <div class="menu-item" id="m-top"><img src="https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/1656CF23-37C3-4E2D-B9B5-7A86688E4DC0.webp" class="menu-icon" id="img-top"></div>
                <div class="menu-item" id="m-shop"><img src="https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/6E3CA577-B227-4A8B-9929-A020B6B6AF5C.webp" class="menu-icon" id="img-shop"></div>
                <div class="menu-item" id="m-account"><img src="https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/96CCD0ED-D67B-4AD3-823E-35FD2BECCAB2.webp" class="menu-icon" id="img-account"></div>
                <div class="menu-item" id="m-workers"><img src="https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/F0374C7C-C546-4CF7-8BCD-3E8137BEC8EA.webp" class="menu-icon" id="img-workers"></div>
                <div class="menu-item" id="m-dayoff"><img src="https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/EBD0902B-4CCD-44C4-94FD-C5CF1E27F3F5.webp" class="menu-icon" id="img-dayoff"></div>
            </div>
        </div>
    </div>

    <div id="profile-screen" class="screen">
        <div class="canvas">
            <div class="top-logo-box"></div>
            <div class="panel-container profile-panel">
                <div class="lang-switch-btn" onclick="toggleLang()">üåê</div>
                <div class="panel-title" id="prof-screen-title" data-i18n="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
                <div style="width:100%; overflow-y:auto; flex-grow:1; -webkit-overflow-scrolling: touch; padding-right:5px;">
                    <div class="input-label" data-i18n="first_name">–ò–º—è</div>
                    <input type="text" id="prof-fname" class="panel-input" placeholder="–ò–º—è">
                    <div class="input-label" data-i18n="last_name">–§–∞–º–∏–ª–∏—è</div>
                    <input type="text" id="prof-lname" class="panel-input" placeholder="–§–∞–º–∏–ª–∏—è">
                    <div class="input-label" data-i18n="login">–õ–æ–≥–∏–Ω</div>
                    <input type="text" id="prof-login" class="panel-input" placeholder="–õ–æ–≥–∏–Ω">
                    <div class="input-label" data-i18n="birthday">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</div>
                    <input type="text" id="prof-dob" class="panel-input" placeholder="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
                    <div class="input-label" data-i18n="start_date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</div>
                    <input type="text" id="prof-workdate" class="panel-input" placeholder="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã (27.05.2025)">
                    <div class="input-label" data-i18n="tg_id">TG id</div>
                    <input type="text" id="prof-id" class="panel-input" placeholder="ID (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)">
                </div>
                <button class="btn-panel btn-panel-gold" onclick="submitProfile()" data-i18n="save">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="btn-panel btn-panel-outline" id="prof-back-btn" onclick="backToMenu()" data-i18n="back">–ù–ê–ó–ê–î</button>
            </div>
        </div>
    </div>
    
    <div id="clocks-screen" class="screen">
        <div class="canvas">
            <div class="top-logo-box"></div>
            <div class="panel-container clocks-panel">
                <div class="panel-title" id="clocks-panel-title" data-i18n="my_firms">–ú–æ–∏ —Ñ–∏—Ä–º—ã</div>
                
                <div class="header-controls-wrapper" id="clocks-header-controls">
                    <span style="color:var(--gold); font-weight:900; font-size: 10px; text-transform: uppercase;" data-i18n="name_header">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
                    <div class="inner-btn-wrap">
                        <button class="btn-header-action" onclick="addFirm()">+</button>
                        <button class="btn-header-action" id="btn-del-mode" onclick="toggleDelFirm()">-</button>
                    </div>
                </div>

                <div id="firm-list-container" style="width:100%; flex-grow:1; overflow-y:auto; margin-bottom:10px;"></div>
                <button class="btn-panel btn-panel-outline" id="clocks-back-btn" onclick="backToMenu()" data-i18n="back">–ù–ê–ó–ê–î</button>
            </div>
        </div>
    </div>
    
    <div id="hours-screen" class="screen">
        <div class="canvas">
            <div class="top-logo-box"></div>
            <div class="hours-unified-panel">
                <div class="panel-title" id="current-firm-name">–§–ò–†–ú–ê</div>
                <div class="table-scroll-container">
                    <table class="hours-table-main">
                        <thead>
                            <tr>
                                <th data-i18n="th_d">–î</th>
                                <th data-i18n="th_from">–û–¢</th>
                                <th data-i18n="th_to">–î–û</th>
                                <th data-i18n="th_h">–ß</th>
                                <th data-i18n="th_obj">–û–ë–™–ï–ö–¢</th>
                            </tr>
                        </thead>
                        <tbody id="hours-tbody"></tbody>
                    </table>
                </div>
                <div style="color:gold; text-align:right; padding:10px; font-weight:900; width: 100%;" data-i18n="total_hours_prefix">–ò–¢–û–ì–û: <span id="table-total-val">0</span> –ß</div>
                <div class="beautiful-btns-grid" id="hours-actions-grid">
                    <button class="btn-beaut" style="background:green; color:white;" onclick="saveHoursData(true)" data-i18n="save_btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-beaut" style="background:red; color:white;" onclick="clearHoursData()" data-i18n="clear_btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    <button class="btn-beaut" style="background:gold; color:black;" onclick="sendHoursReport()" data-i18n="send_btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <button class="btn-beaut" style="background:#333; color:white;" onclick="closeHoursScreen()" data-i18n="back">–ù–∞–∑–∞–¥</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="account-screen" class="screen">
        <div class="canvas">
            <div class="top-logo-box"></div>
            <div class="panel-container acc-panel">
                <div class="panel-title" data-i18n="account">–°—á–µ—Ç</div> <div id="acc-stats-box" style="width:100%;"></div>
                <button class="btn-panel btn-panel-outline" onclick="backToMenu()" style="margin-top:15px;" data-i18n="back">–ù–ê–ó–ê–î</button>
            </div>
        </div>
    </div>
    
    <div id="top-screen" class="screen">
        <div class="canvas">
            <div class="top-logo-box"></div>
            <div class="panel-container top-panel">
                <div class="panel-title" data-i18n="rating">–†–µ–π—Ç–∏–Ω–≥</div>
                <div class="top-header-frame">
                    <div class="top-tabs">
                        <button class="top-tab active" onclick="switchTopTab('adv')" id="tab-adv" data-i18n="top_adv">–¢–û–ü –ê–í–ê–ù–°</button>
                        <button class="top-tab" onclick="switchTopTab('exp')" id="tab-exp" data-i18n="top_exp">–¢–û–ü –°–¢–ê–ñ</button>
                    </div>
                    <div id="top-global-summary" style="color:gold; font-size:16px; font-weight:bold; text-align:center; width:100%; padding-top:2px;"></div>
                </div>
                <div class="leaderboard-box" id="leaderboard-content"></div>
                <button class="btn-panel btn-panel-outline" onclick="backToMenu()" data-i18n="back">–ù–ê–ó–ê–î</button>
            </div>
        </div>
    </div>
    
    <div id="advances-screen" class="screen">
        <div class="canvas">
            <div class="top-logo-box"></div>
            <div class="panel-container adv-panel">
                <div class="panel-title" data-i18n="advance">–ê–≤–∞–Ω—Å</div>
                <select id="adv-currency" class="panel-input">
                    <option value="czk">CZK (–∫—Ä–æ–Ω—ã)</option>
                    <option value="eur">EUR (–µ–≤—Ä–æ)</option>
                </select>
                <input type="number" id="adv-amount" class="panel-input" placeholder="–°—É–º–º–∞" data-i18n-ph="ph_amount">
                <input type="text" id="adv-reason" class="panel-input" placeholder="–ü—Ä–∏—á–∏–Ω–∞" data-i18n-ph="ph_reason">
                <button class="btn-panel btn-panel-gold" onclick="submitAdvance()" data-i18n="send_btn_upper">–û–¢–ü–†–ê–í–ò–¢–¨</button>
                <button class="btn-panel btn-panel-outline" onclick="backToMenu()" data-i18n="back">–ù–ê–ó–ê–î</button>
            </div>
        </div>
    </div>
    
    <div id="shop-screen" class="screen">
        <div class="canvas">
            <div class="top-logo-box"></div>
            <div class="panel-container shop-panel" style="height: 415px;">
                <div class="panel-title" data-i18n="shop">–ú–∞–≥–∞–∑–∏–Ω</div>
                
                <div id="shop-admin-controls" class="header-controls-wrapper" style="display:none;">
                    <span style="color:var(--gold); font-weight:900; font-size: 10px; text-transform: uppercase;" data-i18n="products">–¢–æ–≤–∞—Ä—ã</span>
                    <div class="inner-btn-wrap">
                        <button class="btn-header-action" onclick="toggleAddProduct()">+</button>
                        <button class="btn-header-action" onclick="toggleShopDeleteMode()">-</button>
                    </div>
                </div>
                
                <div id="shop-user-title" class="user-shop-title-wrapper" style="display:none;">
                    <span style="color:var(--gold); font-weight:900; font-size: 12px; text-transform: uppercase;" data-i18n="products">–¢–æ–≤–∞—Ä—ã</span>
                </div>

                <div id="add-product-table">
                   <input type="text" id="new-prod-name" class="panel-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" data-i18n-ph="ph_prod_name">
                   <input type="text" id="new-prod-unit" class="panel-input" placeholder="—à—Ç, –≥, —á–∞—Ä–∞, –∫–≥" data-i18n-ph="ph_prod_unit">
                   <button class="btn-panel btn-panel-gold" onclick="confirmAddProduct()" data-i18n="add_btn">–î–û–ë–ê–í–ò–¢–¨</button>
                </div>

                <div id="shop-items-container" style="width:100%; overflow-y:auto; flex-grow:1; -webkit-overflow-scrolling: touch; margin-bottom:10px;">
                    </div>

                <button id="shop-order-btn" class="btn-panel btn-panel-gold" onclick="orderShop()" data-i18n="order_btn">–ó–ê–ö–ê–ó–ê–¢–¨</button>
                <button class="btn-panel btn-panel-outline" onclick="backToMenu()" data-i18n="back">–ù–ê–ó–ê–î</button>
            </div>
        </div>
    </div>
    
    <div id="workers-screen" class="screen">
        <div class="canvas">
            <div class="top-logo-box"></div>
            <div class="panel-container workers-panel">
                <div class="panel-title" data-i18n="workers">–†–∞–±–æ—Ç–Ω–∏–∫–∏</div>
                <div class="workers-header-wrapper">
                    <span style="color:var(--gold); font-weight:900; font-size: 10px; text-transform: uppercase;" data-i18n="logins">–õ–æ–≥–∏–Ω—ã</span>
                    <div class="trash-btn-outer" onclick="toggleWorkerDeleteMode()">
                        <span style="font-size: 14px;">üóëÔ∏è</span>
                    </div>
                </div>
                <div id="workers-list" style="width:100%; overflow-y:auto; flex-grow:1;"></div>
                <button class="btn-panel btn-panel-outline" onclick="backToMenu()" style="margin-top:10px;" data-i18n="back">–ù–ê–ó–ê–î</button>
            </div>
        </div>
    </div>

    <div id="worker-edit-screen" class="screen">
        <div class="canvas">
            <div class="top-logo-box"></div>
            <div class="panel-container worker-edit-panel">
                <div class="panel-title" id="we-title" data-i18n="worker">–†–∞–±–æ—Ç–Ω–∏–∫</div>
                <div id="we-content" style="width:100%;"></div>
                <button class="btn-panel btn-panel-outline" onclick="showScreen('workers-screen')" style="margin-top:15px;" data-i18n="back">–ù–ê–ó–ê–î</button>
            </div>
        </div>
    </div>
    
    <div id="dayoff-screen" class="screen">
        <div class="canvas">
            <div class="top-logo-box"></div>
            <div class="panel-container do-panel">
                <div class="panel-title" data-i18n="day_off">–í—ã—Ö–æ–¥–Ω–æ–π</div>
                <input type="text" class="panel-input" id="do-date" placeholder="–î–∞—Ç–∞" data-i18n-ph="ph_date">
                <input type="text" class="panel-input" id="do-reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞" data-i18n-ph="ph_reason">
                <button class="btn-panel btn-panel-gold" onclick="sendDayOff()" data-i18n="send_btn_upper">–û–¢–ü–†–ê–í–ò–¢–¨</button>
                <button class="btn-panel btn-panel-outline" onclick="backToMenu()" data-i18n="back">–ù–ê–ó–ê–î</button>
            </div>
        </div>
    </div>

    <script>
        const fixedBg = document.getElementById('fixed-bg');
        const WORKER_URL = 'https://snowy-block-fcdb.cryptokakhnych.workers.dev';
        const SUPABASE_URL = 'https://mnexoturnujxjjicfukc.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uZXhvdHVybnVqeGpqaWNmdWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MTY1MzksImV4cCI6MjA4NTA5MjUzOX0.Ye4PJuEpuyLLRACkv72tvf0mh7IBn7JYRA8OJ1kLrc0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Localization System ---
        const translations = {
            ru: {
                profile: "–ü—Ä–æ—Ñ–∏–ª—å", first_name: "–ò–º—è", last_name: "–§–∞–º–∏–ª–∏—è", login: "–õ–æ–≥–∏–Ω", birthday: "–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è", start_date: "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã", tg_id: "TG id", save: "–°–û–•–†–ê–ù–ò–¢–¨", back: "–ù–ê–ó–ê–î",
                my_firms: "–ú–æ–∏ —Ñ–∏—Ä–º—ã", name_header: "–ù–∞–∑–≤–∞–Ω–∏–µ", th_d: "–î", th_from: "–û–¢", th_to: "–î–û", th_h: "–ß", th_obj: "–û–ë–™–ï–ö–¢", total_hours_prefix: "–ò–¢–û–ì–û: ", save_btn: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", clear_btn: "–û—á–∏—Å—Ç–∏—Ç—å", send_btn: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
                account: "–°—á–µ—Ç", rating: "–†–µ–π—Ç–∏–Ω–≥", top_adv: "–¢–û–ü –ê–í–ê–ù–°", top_exp: "–¢–û–ü –°–¢–ê–ñ", advance: "–ê–≤–∞–Ω—Å", ph_amount: "–°—É–º–º–∞", ph_reason: "–ü—Ä–∏—á–∏–Ω–∞", send_btn_upper: "–û–¢–ü–†–ê–í–ò–¢–¨", shop: "–ú–∞–≥–∞–∑–∏–Ω", products: "–¢–æ–≤–∞—Ä—ã", ph_prod_name: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞", ph_prod_unit: "—à—Ç, –≥, —á–∞—Ä–∞, –∫–≥", add_btn: "–î–û–ë–ê–í–ò–¢–¨", order_btn: "–ó–ê–ö–ê–ó–ê–¢–¨", workers: "–†–∞–±–æ—Ç–Ω–∏–∫–∏", logins: "–õ–æ–≥–∏–Ω—ã", worker: "–†–∞–±–æ—Ç–Ω–∏–∫", day_off: "–í—ã—Ö–æ–¥–Ω–æ–π", ph_date: "–î–∞—Ç–∞",
                adv_czk_label: "–ê–≤–∞–Ω—Å—ã –∫—Ä–æ–Ω—ã:", adv_eur_label: "–ê–≤–∞–Ω—Å—ã –µ–≤—Ä–æ:", fines_label: "–®—Ç—Ä–∞—Ñ—ã:", to_pay_label: "–ö –í–´–î–ê–ß–ï:", veteran_rating: "–†–ï–ô–¢–ò–ù–ì –í–ï–¢–ï–†–ê–ù–û–í", days_suffix: " –¥–Ω.",
                alert_id: "ID –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!", alert_saved: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!", alert_admin: "–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º", btn_select: "–í–´–ë–†–ê–¢–¨", ph_firm_name: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏—Ä–º—ã:", confirm_del_firm: '–£–¥–∞–ª–∏—Ç—å —Ñ–∏—Ä–º—É "{firm}" –∏ –≤—Å–µ –µ—ë –¥–∞–Ω–Ω—ã–µ?',
                alert_total_empty: "–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ.", alert_sent_ok: "–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!", alert_order_empty: "–ü—É—Å—Ç–æ–π –∑–∞–∫–∞–∑!", alert_confirm_worker: "–í—ã —É–≤–µ—Ä–µ–Ω—ã? –†–∞–±–æ—Ç–Ω–∏–∫ –∏ –í–°–ï –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞!",
                loading_shop: "–ó–∞–≥—Ä—É–∑–∫–∞...", no_products: "–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤", no_firms: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–∏—Ä–º–∞—Ö", no_data: "–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            },
            cs: {
                profile: "Profil", first_name: "Jm√©no", last_name: "P≈ô√≠jmen√≠", login: "Login", birthday: "Datum narozen√≠", start_date: "Datum n√°stupu", tg_id: "TG id", save: "ULO≈ΩIT", back: "ZPƒöT",
                my_firms: "Moje firmy", name_header: "N√°zev", th_d: "D", th_from: "OD", th_to: "DO", th_h: "H", th_obj: "OBJEKT", total_hours_prefix: "CELKEM: ", save_btn: "Ulo≈æit", clear_btn: "Vymazat", send_btn: "Odeslat",
                account: "√öƒçet", rating: "≈Ωeb≈ô√≠ƒçek", top_adv: "TOP Z√ÅLOHY", top_exp: "TOP PRAXE", advance: "Z√°loha", ph_amount: "ƒå√°stka", ph_reason: "D≈Øvod", send_btn_upper: "ODESLAT", shop: "Obchod", products: "Zbo≈æ√≠", ph_prod_name: "N√°zev zbo≈æ√≠", ph_prod_unit: "ks, g, ƒç√°ra, kg", add_btn: "P≈òIDAT", order_btn: "OBJEDNAT", workers: "Pracovn√≠ci", logins: "U≈æivatel√©", worker: "Pracovn√≠k", day_off: "Volno", ph_date: "Datum",
                adv_czk_label: "Z√°lohy koruny:", adv_eur_label: "Z√°lohy euro:", fines_label: "Pokuty:", to_pay_label: "K V√ùPLATƒö:", veteran_rating: "≈ΩEB≈ò√çƒåEK VETER√ÅN≈Æ", days_suffix: " dn√≠",
                alert_id: "ID je povinn√©!", alert_saved: "Ulo≈æeno!", alert_admin: "P≈ô√≠stup pouze pro administr√°tory", btn_select: "VYBRAT", ph_firm_name: "N√°zev firmy:", confirm_del_firm: 'Smazat firmu "{firm}" a v≈°echna jej√≠ data?',
                alert_total_empty: "Tabulka je pr√°zdn√°. Vypl≈àte data.", alert_sent_ok: "√öspƒõ≈°nƒõ odesl√°no!", alert_order_empty: "Pr√°zdn√° objedn√°vka!", alert_confirm_worker: "Jste si jisti? Pracovn√≠k a V≈†ECHNA jeho data budou nav≈ædy smaz√°na!",
                loading_shop: "Naƒç√≠t√°n√≠...", no_products: "≈Ω√°dn√© zbo≈æ√≠", no_firms: "≈Ω√°dn√© √∫daje o firm√°ch", no_data: "Data nebyla nalezena."
            }
        };

        let currentLang = localStorage.getItem('monek_lang') || 'ru';

        function applyLang() {
            const langData = translations[currentLang];
            // –ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (langData[key]) el.innerText = langData[key];
            });
            // –ü–µ—Ä–µ–≤–æ–¥ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤
            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const key = el.getAttribute('data-i18n-ph');
                if (langData[key]) el.placeholder = langData[key];
            });
        }

        function toggleLang() {
            currentLang = currentLang === 'ru' ? 'cs' : 'ru';
            localStorage.setItem('monek_lang', currentLang);
            applyLang();
            renderFirms();
            renderWorkers();
            updateMyStats();
            if (document.getElementById('top-screen').classList.contains('active')) {
                const activeTab = document.getElementById('tab-adv').classList.contains('active') ? 'adv' : 'exp';
                switchTopTab(activeTab);
            }
        }
        // --- End Localization ---

        let firms = JSON.parse(localStorage.getItem('monek_firms')) || ["Monek Group"];
        let dbUsers = [];
        let curF = "";
        let deleteMode = false;
        let shopDeleteMode = false;
        let workerDeleteMode = false; 
        let currentWorkerId = null;
        let isAdminViewing = false; 

        const ADMIN_IDS = ["7384770465", "663587165"];

        let initialHeight = window.innerHeight;
        let initialWidth = window.innerWidth;

        const ASSETS_TO_PRELOAD = [
            'https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/9B5D449E-418A-45D3-B788-8778649B65DC.webp',
            'https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/D89BBBDF-73C1-4649-9D84-C7B9A8A072AF.webp',
            'https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/55CB662D-41CA-47A0-B87B-097BF580D9EF.webp',
            'https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/D6D08605-797C-407A-AC9F-CA1D85241C3A.webp',
            'https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/8CF47A13-928B-47FC-9494-D6354E56BB25.webp',
            'https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/9B30F657-53D7-4158-91D6-5F004D6E3D19.webp',
            'https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/1656CF23-37C3-4E2D-B9B5-7A86688E4DC0.webp',
            'https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/6E3CA577-B227-4A8B-9929-A020B6B6AF5C.webp',
            'https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/96CCD0ED-D67B-4AD3-823E-35FD2BECCAB2.webp',
            'https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/F0374C7C-C546-4CF7-8BCD-3E8137BEC8EA.webp',
            'https://cdn.jsdelivr.net/gh/cryptokakhnych/webp-monek@main/EBD0902B-4CCD-44C4-94FD-C5CF1E27F3F5.webp'
        ];

        function fixViewportHeight() {
            if (Math.abs(window.innerWidth - initialWidth) > 5) {
                initialHeight = window.innerHeight;
                initialWidth = window.innerWidth;
            }
            document.documentElement.style.setProperty('--vh', `${initialHeight}px`);
        }
        window.addEventListener('resize', fixViewportHeight);
        fixViewportHeight();

        function parseDate(input) {
            if(!input) return null;
            if(input.includes('.')) {
                const parts = input.split('.');
                if(parts.length === 3) return new Date(parts[2], parts[1]-1, parts[0]);
            }
            const d = new Date(input);
            return isNaN(d.getTime()) ? null : d;
        }

        async function preloadImages() {
            const promises = ASSETS_TO_PRELOAD.map(url => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = url;
                    img.onload = resolve;
                    img.onerror = resolve; 
                });
            });
            await Promise.all(promises);
        }

        async function initApp() {
            applyLang();
            renderFirms();
            generateDaysTable();
            await loadProfileData();
            await fetchLeaderboardData();

            setBg('var(--bg-loader)');

            document.getElementById('m-profile').onclick = () => { isAdminViewing = false; showScreen('profile-screen', 'var(--bg-main)'); };
            document.getElementById('m-clocks').onclick = () => { 
                isAdminViewing = false; 
                document.getElementById('clocks-panel-title').innerText = translations[currentLang].my_firms;
                document.getElementById('clocks-header-controls').style.display = 'flex';
                document.getElementById('clocks-back-btn').onclick = backToMenu;
                renderFirms();
                showScreen('clocks-screen', 'var(--bg-main)'); 
            };
            document.getElementById('m-advances').onclick = () => showScreen('advances-screen', 'var(--bg-main)');
            document.getElementById('m-top').onclick = () => { fetchLeaderboardData(); switchTopTab('adv'); showScreen('top-screen', 'var(--bg-main)'); };
            document.getElementById('m-shop').onclick = () => { setupShopUI(); showScreen('shop-screen', 'var(--bg-main)'); };
            document.getElementById('m-account').onclick = () => { fetchLeaderboardData(); showScreen('account-screen', 'var(--bg-main)'); };
            
            document.getElementById('m-workers').onclick = () => { 
                const p = JSON.parse(localStorage.getItem('monek_prof'));
                if(p && p.external_id && ADMIN_IDS.includes(String(p.external_id))) {
                    workerDeleteMode = false; 
                    fetchLeaderboardData(); 
                    showScreen('workers-screen', 'var(--bg-main)'); 
                } else {
                    alert(translations[currentLang].alert_admin);
                }
            };
            
            document.getElementById('m-dayoff').onclick = () => showScreen('dayoff-screen', 'var(--bg-main)');

            const bar = document.getElementById('progress-bar');
            const txt = document.getElementById('loading-text');
            let start = Date.now(), dur = 2500; 

            const assetsPromise = preloadImages();

            const frame = async () => {
                let pct = Math.min(((Date.now()-start)/dur)*100, 100);
                bar.style.width = pct+'%'; 
                txt.innerText = Math.floor(pct)+'%';
                
                if(pct < 100) {
                    requestAnimationFrame(frame);
                } else {
                    await assetsPromise;
                    setTimeout(() => showScreen('menu-screen', 'var(--bg-menu)'), 300);
                }
            };
            requestAnimationFrame(frame);
        }

        function setBg(imgVar) {
            fixedBg.style.backgroundImage = imgVar;
        }

        function showScreen(id, bgVar) {
            const current = document.querySelector('.screen.active');
            const target = document.getElementById(id);
            if(current) {
                current.style.opacity = '0';
                current.style.transform = 'scale(1.05)'; 
                setTimeout(() => {
                    current.classList.remove('active');
                    current.style.display = 'none';
                    target.style.display = 'block';
                    setTimeout(() => {
                        target.style.transform = 'scale(1)';
                        target.classList.add('active');
                        target.style.opacity = '1';
                    }, 20);
                }, 400); 
            } else {
                target.style.display = 'block';
                target.style.transform = 'scale(1)';
                target.classList.add('active');
                target.style.opacity = '1';
            }
            if(bgVar) setBg(bgVar);
        }

        function backToMenu() { showScreen('menu-screen', 'var(--bg-menu)'); }

        async function setupShopUI() {
            const p = JSON.parse(localStorage.getItem('monek_prof'));
            const isAdmin = p && p.external_id && ADMIN_IDS.includes(String(p.external_id));
            document.getElementById('shop-admin-controls').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('shop-user-title').style.display = isAdmin ? 'none' : 'block';
            document.getElementById('add-product-table').style.display = 'none';
            shopDeleteMode = false;
            
            await loadShopItems();
        }

        async function loadShopItems() {
            const container = document.getElementById('shop-items-container');
            container.innerHTML = `<div style="color:gold; text-align:center; padding:10px;">${translations[currentLang].loading_shop}</div>`;
            
            const { data, error } = await supabaseClient.from('shop_items').select('*');
            
            if(error) {
                console.error("Shop load error:", error);
                return;
            }

            container.innerHTML = '';
            if(data && data.length > 0) {
                data.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'shop-row';
                    row.dataset.id = item.id;
                    row.dataset.name = item.name;
                    row.dataset.unit = item.unit;
                    row.innerHTML = `
                        <div class="shop-info">${item.name} <span class="shop-subtext">${item.unit}</span></div>
                        <input type="number" class="shop-qty-input" placeholder="0">
                        <div class="shop-del-btn" style="display:none; color:red; cursor:pointer;" onclick="deleteShopItem('${item.id}')">üóëÔ∏è</div>
                    `;
                    container.appendChild(row);
                });
            } else {
                container.innerHTML = `<div style="color:gray; text-align:center; padding:20px;">${translations[currentLang].no_products}</div>`;
            }
        }

        function toggleAddProduct() {
            const tbl = document.getElementById('add-product-table');
            tbl.style.display = (tbl.style.display === 'none' || tbl.style.display === '') ? 'block' : 'none';
        }

        async function confirmAddProduct() {
            const name = document.getElementById('new-prod-name').value;
            const unit = document.getElementById('new-prod-unit').value;
            if(!name || !unit) return alert(currentLang === 'ru' ? "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!" : "Vypl≈àte pole!");
            
            const { error } = await supabaseClient.from('shop_items').insert([{ name, unit }]);
            
            if(error) {
                alert("Error: " + error.message);
            } else {
                document.getElementById('new-prod-name').value = '';
                document.getElementById('new-prod-unit').value = '';
                toggleAddProduct();
                await loadShopItems();
            }
        }

        function toggleShopDeleteMode() {
            shopDeleteMode = !shopDeleteMode;
            const rows = document.querySelectorAll('.shop-row');
            rows.forEach(row => {
                const input = row.querySelector('.shop-qty-input');
                const delBtn = row.querySelector('.shop-del-btn');
                if(shopDeleteMode) {
                    input.style.display = 'none';
                    delBtn.style.display = 'block';
                } else {
                    input.style.display = 'block';
                    delBtn.style.display = 'none';
                }
            });
        }

        async function deleteShopItem(id) {
            const msg = currentLang === 'ru' ? "–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –±–∞–∑—ã?" : "Smazat toto zbo≈æ√≠ z datab√°ze?";
            if(confirm(msg)) {
                const { error } = await supabaseClient.from('shop_items').delete().eq('id', id);
                if(error) alert("Error: " + error.message);
                else {
                    shopDeleteMode = false;
                    await loadShopItems();
                }
            }
        }

        function resetShopRows() {
            document.querySelectorAll('.shop-qty-input').forEach(i => i.style.display = 'block');
            document.querySelectorAll('.shop-del-btn').forEach(b => b.style.display = 'none');
        }

        async function submitProfile() {
            const p = {
                login: document.getElementById('prof-login').value,
                dob: document.getElementById('prof-dob').value,
                work: document.getElementById('prof-workdate').value,
                external_id: document.getElementById('prof-id').value,
                first_name: document.getElementById('prof-fname').value,
                last_name: document.getElementById('prof-lname').value
            };
            if(!p.external_id) { alert(translations[currentLang].alert_id); return; }
            
            if(!isAdminViewing) localStorage.setItem('monek_prof', JSON.stringify(p));
            
            const targetId = isAdminViewing ? currentWorkerId : p.external_id;

            const { error } = await supabaseClient.from('profiles').upsert([{
                external_id: targetId, login: p.login, dob: p.dob, work_date: p.work,
                first_name: p.first_name, last_name: p.last_name
            }], { onConflict: 'external_id' });
            
            if(error) alert("Error: " + error.message);
            else { 
                alert(translations[currentLang].alert_saved); 
                if(isAdminViewing) {
                   await fetchLeaderboardData(); 
                   showScreen('workers-screen');
                } else backToMenu(); 
            }
        }

        async function loadProfileData() {
            let p = JSON.parse(localStorage.getItem('monek_prof'));
            if(p) {
                document.getElementById('prof-login').value = p.login || "";
                document.getElementById('prof-dob').value = p.dob || "";
                document.getElementById('prof-workdate').value = p.work || "";
                document.getElementById('prof-id').value = p.external_id || "";
                document.getElementById('prof-fname').value = p.first_name || "";
                document.getElementById('prof-lname').value = p.last_name || "";
            }
        }

        async function renderFirms() {
            const c = document.getElementById('firm-list-container');
            c.innerHTML = '';
            
            let firmList = firms;
            if(isAdminViewing && currentWorkerId) {
                const { data } = await supabaseClient.from('hours').select('firm_name').eq('external_id', currentWorkerId);
                firmList = data ? [...new Set(data.map(i => i.firm_name))] : [];
                if(firmList.length === 0) {
                    c.innerHTML = `<div style="color:gray; text-align:center; padding:20px;">${translations[currentLang].no_firms}</div>`;
                    return;
                }
            }

            firmList.forEach((f, i) => {
                let actionBtn = (!isAdminViewing && deleteMode)
                    ? `<span style="font-size:20px; cursor:pointer;" onclick="deleteFirm(${i})">üóëÔ∏è</span>`
                    : `<button class="btn-panel-gold btn-small" onclick="openHours('${f}')" style="font-weight:900; padding:5px 10px; font-size:10px; border-radius:4px; border:none; cursor:pointer;">${translations[currentLang].btn_select}</button>`;
                c.innerHTML += `<div class="firm-item-card">
                    <span style="color:white;">${f}</span><div>${actionBtn}</div></div>`;
            });
        }

        function addFirm() {
            let n = prompt(translations[currentLang].ph_firm_name);
            if(n) { firms.push(n); localStorage.setItem('monek_firms', JSON.stringify(firms)); renderFirms(); }
        }

        function toggleDelFirm() {
            deleteMode = !deleteMode;
            document.getElementById('btn-del-mode').classList.toggle('active', deleteMode);
            renderFirms();
        }

        async function deleteFirm(index) {
            const firmToDelete = firms[index];
            const msg = translations[currentLang].confirm_del_firm.replace("{firm}", firmToDelete);
            if(confirm(msg)) {
                const p = JSON.parse(localStorage.getItem('monek_prof'));
                if(p && p.external_id) {
                    await supabaseClient.from('hours').delete().match({ external_id: p.external_id, firm_name: firmToDelete });
                }
                localStorage.removeItem('h_' + firmToDelete);
                firms.splice(index, 1);
                localStorage.setItem('monek_firms', JSON.stringify(firms));
                deleteMode = false;
                document.getElementById('btn-del-mode').classList.remove('active');
                renderFirms();
            }
        }

        function generateDaysTable() {
            const b = document.getElementById('hours-tbody');
            b.innerHTML = '';
            for(let i=1; i<=31; i++) {
                b.innerHTML += `<tr><td>${i}</td><td><input type="text" class="hour-input-cell inp-f" oninput="calcH(this)"></td>
                    <td><input type="text" class="hour-input-cell inp-t" oninput="calcH(this)"></td><td class="res-h">0</td>
                    <td><input type="text" class="hour-input-cell inp-s"></td></tr>`;
            }
        }

        async function openHours(f) {
            curF = f;
            document.getElementById('current-firm-name').innerText = f;
            const targetId = isAdminViewing ? currentWorkerId : JSON.parse(localStorage.getItem('monek_prof'))?.external_id;
            
            const { data } = await supabaseClient.from('hours').select('*').match({ external_id: targetId, firm_name: f });
            const dataToShow = Array(31).fill(null).map((_, i) => {
                const found = data ? data.find(d => d.day_number === (i+1)) : null;
                return found ? { f: found.hour_from, t: found.hour_to, h: found.hours_total, s: found.object_name } : {};
            });

            document.querySelectorAll('#hours-tbody tr').forEach((tr, i) => {
                const d = dataToShow[i] || {};
                tr.querySelector('.inp-f').value = d.f || "";
                tr.querySelector('.inp-t').value = d.t || "";
                tr.querySelector('.res-h').innerText = d.h || "0";
                tr.querySelector('.inp-s').value = d.s || "";
                tr.querySelectorAll('input').forEach(inp => inp.readOnly = false);
            });
            updateTotal();
            showScreen('hours-screen', 'var(--bg-hours)');
        }

        function parseTimeToDecimal(timeStr) {
            if (!timeStr) return null;
            timeStr = timeStr.toString().replace(',', '.');
            if (timeStr.includes(':')) {
                const [h, m] = timeStr.split(':').map(val => parseFloat(val) || 0);
                return h + (m / 60);
            }
            return parseFloat(timeStr) || 0;
        }

        function calcH(el) {
            const tr = el.closest('tr');
            const fRaw = tr.querySelector('.inp-f').value;
            const tRaw = tr.querySelector('.inp-t').value;
            const f = parseTimeToDecimal(fRaw);
            const t = parseTimeToDecimal(tRaw);
            const res = tr.querySelector('.res-h');
            
            if(f !== null && t !== null && t > f) { 
                let diff = t - f;
                if (t > 12) diff -= 0.5;
                res.innerText = diff > 0 ? diff.toFixed(2).replace(/\.00$/, '') : 0; 
            } else res.innerText = "0";
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll('.res-h').forEach(td => total += parseFloat(td.innerText) || 0);
            document.getElementById('table-total-val').innerText = total.toFixed(2).replace(/\.00$/, '');
        }

        async function saveHoursData(showAlert = false) {
            const targetId = isAdminViewing ? currentWorkerId : JSON.parse(localStorage.getItem('monek_prof'))?.external_id;
            if(!targetId) { if(showAlert) alert("ID Error!"); return; }

            const rows = Array.from(document.querySelectorAll('#hours-tbody tr'));
            const localData = rows.map(tr => ({
                f: tr.querySelector('.inp-f').value, 
                t: tr.querySelector('.inp-t').value,
                h: tr.querySelector('.res-h').innerText, 
                s: tr.querySelector('.inp-s').value
            }));

            if(!isAdminViewing) localStorage.setItem('h_'+curF, JSON.stringify(localData));

            const dbRows = rows.map((tr, index) => {
                const hVal = parseFloat(tr.querySelector('.res-h').innerText);
                const sVal = tr.querySelector('.inp-s').value;
                if(hVal > 0 || (sVal && sVal.trim() !== "")) {
                    return {
                        external_id: targetId, firm_name: curF, day_number: index + 1,
                        hour_from: tr.querySelector('.inp-f').value,
                        hour_to: tr.querySelector('.inp-t').value,
                        hours_total: hVal, object_name: sVal
                    };
                }
                return null;
            }).filter(item => item !== null);

            await supabaseClient.from('hours').delete().match({ external_id: targetId, firm_name: curF });

            if(dbRows.length > 0) {
                const { error } = await supabaseClient.from('hours').upsert(dbRows);
                if(error && showAlert) alert("DB Error: " + error.message);
                else if(showAlert) alert(translations[currentLang].alert_saved);
            } else if(showAlert) alert(translations[currentLang].alert_total_empty);
        }

        async function clearHoursData() {
            const msg = currentLang === 'ru' ? "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —á–∞—Å–æ–≤ —ç—Ç–æ–π —Ñ–∏—Ä–º—ã?" : "Smazat v≈°echna data hodin pro tuto firmu?";
            if(!confirm(msg)) return;
            const targetId = isAdminViewing ? currentWorkerId : JSON.parse(localStorage.getItem('monek_prof'))?.external_id;
            
            if(targetId) {
                await supabaseClient.from('hours').delete().match({ external_id: targetId, firm_name: curF });
            }
            if(!isAdminViewing) localStorage.removeItem('h_'+curF);

            document.querySelectorAll('#hours-tbody tr').forEach(tr => {
                tr.querySelector('.inp-f').value = ""; tr.querySelector('.inp-t').value = "";
                tr.querySelector('.res-h').innerText = "0"; tr.querySelector('.inp-s').value = "";
            });
            updateTotal();
        }

        async function sendRequestToWorker(data) {
             const p = JSON.parse(localStorage.getItem('monek_prof'));
             if (!p || !p.external_id) return alert(translations[currentLang].alert_id);
             data.user_id = p.external_id;
             data.user_name = p.login || "Unknown";
             try {
                 const response = await fetch(`${WORKER_URL}/submit`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                if(response.ok) {
                    alert(translations[currentLang].alert_sent_ok);
                    return true;
                } else {
                    const txt = await response.text();
                    alert("Server Error: " + txt);
                    return false;
                }
             } catch (e) {
                 alert("Network Error: " + e.message);
                 return false;
             }
        }

        async function sendHoursReport() { 
            if(isAdminViewing) return alert("Admin error");
            await saveHoursData(false); 
            const rows = [];
            let total = 0;
            document.querySelectorAll('#hours-tbody tr').forEach(tr => {
                const d = tr.cells[0].innerText;
                const f = tr.querySelector('.inp-f').value;
                const t = tr.querySelector('.inp-t').value;
                const h = parseFloat(tr.querySelector('.res-h').innerText);
                const s = tr.querySelector('.inp-s').value;
                if(h > 0 || (s && s.trim() !== "")) {
                    rows.push({ day: d, from: f || "0", to: t || "0", total: h || 0, object: s || "‚Äî" });
                    total += h || 0;
                }
            });
            if(rows.length === 0) return alert(translations[currentLang].alert_total_empty);
            const ok = await sendRequestToWorker({ type: 'clocks', id: 3, firm: curF, rows: rows, total_hours: total });
            if(ok) {
                backToMenu();
            }
        }

        async function submitAdvance() {
            const amt = document.getElementById('adv-amount').value;
            const res = document.getElementById('adv-reason').value;
            const cur = document.getElementById('adv-currency').value;
            if(!amt) return alert(currentLang === 'ru' ? "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É!" : "Zadejte ƒç√°stku!");
            const ok = await sendRequestToWorker({ type: 'advance', id: 2, amount: amt, reason: `${res} (${cur.toUpperCase()})` });
            if(ok) {
                document.getElementById('adv-amount').value = "";
                document.getElementById('adv-reason').value = "";
                backToMenu();
            }
        }

        async function orderShop() {
            const rows = document.querySelectorAll('.shop-row');
            let orderStrings = [];
            rows.forEach(row => {
                const qty = row.querySelector('.shop-qty-input').value;
                if(qty > 0) {
                    const name = row.dataset.name;
                    const unit = row.dataset.unit;
                    orderStrings.push(`${name} (${unit}) || ${qty}`);
                }
            });
            
            if(orderStrings.length === 0) return alert(translations[currentLang].alert_order_empty);
            
            const ok = await sendRequestToWorker({ 
                type: 'shop', 
                id: 149, 
                amount: 0, 
                reason: orderStrings.join('\n') 
            });
            
            if(ok) {
                document.querySelectorAll('.shop-qty-input').forEach(i => i.value = "");
                backToMenu();
            }
        }

        async function sendDayOff() {
            const date = document.getElementById('do-date').value;
            const res = document.getElementById('do-reason').value;
            if(!date) return alert(currentLang === 'ru' ? "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É!" : "Zadejte datum!");
            const ok = await sendRequestToWorker({ type: 'dayoff', id: 56, amount: 0, reason: `–î–∞—Ç–∞: ${date}, –ü—Ä–∏—á–∏–Ω–∞: ${res}` });
            if(ok) {
                document.getElementById('do-date').value = "";
                document.getElementById('do-reason').value = "";
                backToMenu();
            }
        }

        function closeHoursScreen() { 
            showScreen('clocks-screen', 'var(--bg-main)'); 
        }

        async function fetchLeaderboardData() {
            try {
                const { data } = await supabaseClient.from('profiles').select('*');
                if(data) { dbUsers = data; renderWorkers(); updateMyStats(); }
            } catch (e) { console.error("Leaderboard fetch error", e); }
        }

        function updateMyStats() {
            const savedProf = JSON.parse(localStorage.getItem('monek_prof')) || {};
            const myId = savedProf.external_id;
            const u = dbUsers.find(x => String(x.external_id) === String(myId));
            const box = document.getElementById('acc-stats-box');
            if(u) {
                const toPayCzk = (u.salary || 0) - (u.adv_czk || 0) - (u.fines || 0);
                const advEur = u.adv_eur || 0;
                box.innerHTML = `
                    <div class="stat-row-decor"><span style="color:white;">${translations[currentLang].adv_czk_label}</span><span class="stat-value" style="color:var(--gold);">${u.adv_czk || 0} Kƒç</span></div>
                    <div class="stat-row-decor"><span style="color:white;">${translations[currentLang].adv_eur_label}</span><span class="stat-value" style="color:var(--gold);">${advEur} ‚Ç¨</span></div>
                    <div class="stat-row-decor"><span style="color:white;">${translations[currentLang].fines_label}</span><span class="stat-value" style="color:var(--gold);">${u.fines || 0} Kƒç</span></div>
                    <div class="stat-row" style="border-top:1px solid gold; margin-top:5px; padding-top:10px;">
                    <span>${translations[currentLang].to_pay_label}</span><div style="text-align:right;">
                    <span style="font-size:18px; color:gold; font-weight:900;">${Math.floor(toPayCzk)} Kƒç</span>
                    <span style="font-size:18px; color:gold; font-weight:900; display:block;">${advEur > 0 ? '-' + advEur : advEur} ‚Ç¨</span></div></div>`;
            } else box.innerHTML = `<div style="color:gray; text-align:center; padding:20px;">${translations[currentLang].no_data}</div>`;
        }

        function switchTopTab(tab) {
            document.querySelectorAll('.top-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            const container = document.getElementById('leaderboard-content');
            const summaryDiv = document.getElementById('top-global-summary');
            if(tab === 'adv') {
                let globalEur = 0, globalCzk = 0;
                dbUsers.forEach(u => { globalEur += (u.adv_eur || 0); globalCzk += (u.adv_czk || 0); });
                summaryDiv.innerText = `${globalEur} ‚Ç¨ / ${globalCzk} Kƒç`;
                let html = `<table class="leaderboard-table">`;
                [...dbUsers].sort((a,b) => {
                    let totalA = (a.adv_czk||0) + (a.adv_eur||0) * 24.22;
                    let totalB = (b.adv_czk||0) + (b.adv_eur||0) * 24.22;
                    return totalB - totalA;
                }).forEach((u, i) => {
                    html += `<tr><td>${i+1}.</td><td>${u.login}</td><td>${u.adv_eur||0} ‚Ç¨ / ${u.adv_czk||0} Kƒç</td></tr>`;
                });
                container.innerHTML = html + `</table>`;
            } else {
                summaryDiv.innerText = translations[currentLang].veteran_rating;
                let html = `<table class="leaderboard-table">`;
                [...dbUsers].map(u => {
                    let d = 0, s = parseDate(u.work_date);
                    if(s) d = Math.floor((new Date() - s) / 86400000);
                    return { ...u, d: d > 0 ? d : 0 };
                }).sort((a,b) => b.d - a.d).forEach((u, i) => {
                    html += `<tr><td>${i+1}.</td><td>${u.login}</td><td>${u.d}${translations[currentLang].days_suffix}</td></tr>`;
                });
                container.innerHTML = html + `</table>`;
            }
        }

        function toggleWorkerDeleteMode() {
            workerDeleteMode = !workerDeleteMode;
            renderWorkers();
        }

        async function deleteWorkerCompletely(id) {
            if(!confirm(translations[currentLang].alert_confirm_worker)) return;
            
            try {
                await supabaseClient.from('hours').delete().eq('external_id', id);
                const { error } = await supabaseClient.from('profiles').delete().eq('external_id', id);
                
                if(error) throw error;

                dbUsers = dbUsers.filter(u => String(u.external_id) !== String(id));
                workerDeleteMode = false;
                renderWorkers();
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        function renderWorkers() {
            const c = document.getElementById('workers-list'); c.innerHTML = "";
            dbUsers.forEach(u => {
                let actionArea = "";
                if(workerDeleteMode) {
                    actionArea = `<span style="font-size:20px; cursor:pointer;" onclick="deleteWorkerCompletely('${u.external_id}')">üóëÔ∏è</span>`;
                } else {
                    actionArea = `<button class="btn-panel-gold btn-small" style="padding:4px 12px; font-weight:900; font-size:10px; border-radius:4px; border:none;" onclick="toggleWorkerActions('${u.external_id}')">${translations[currentLang].btn_select}</button>`;
                }

                c.innerHTML += `
                <div class="worker-item-card" id="worker-card-${u.external_id}">
                    <div class="worker-card-header">
                        <div style="color:white;"><b>${u.login}</b><div style="color:white; font-size:10px;">ID: ${u.external_id}</div></div>
                        <div>${actionArea}</div>
                    </div>
                    <div class="worker-actions-menu" id="actions-${u.external_id}">
                        <button class="btn-action-outline" onclick="openWorkerAccount('${u.external_id}')" data-i18n="account">${translations[currentLang].account}</button>
                        <button class="btn-action-outline" onclick="openWorkerClocks('${u.external_id}')" data-i18n="th_h">${translations[currentLang].th_h}</button>
                        <button class="btn-action-outline" onclick="openWorkerProfile('${u.external_id}')" data-i18n="profile">${translations[currentLang].profile}</button>
                    </div>
                </div>`;
            });
        }

        function toggleWorkerActions(id) {
            const menu = document.getElementById('actions-'+id);
            const isActive = menu.classList.contains('active');
            document.querySelectorAll('.worker-actions-menu').forEach(m => m.classList.remove('active'));
            if(!isActive) menu.classList.add('active');
        }

        function openWorkerAccount(id) {
            currentWorkerId = id; const u = dbUsers.find(x => x.external_id == id); if(!u) return;
            document.getElementById('we-title').innerText = u.login;
            const cats = [{id:'ae', name:'Z√°lohy EUR', f:'adv_eur', u:'‚Ç¨', ru:'–ê–≤–∞–Ω—Å—ã EUR'}, {id:'ac', name:'Z√°lohy CZK', f:'adv_czk', u:'Kƒç', ru:'–ê–≤–∞–Ω—Å—ã CZK'}, {id:'fin', name:'Pokuty', f:'fines', u:'Kƒç', ru:'–®—Ç—Ä–∞—Ñ—ã'}];
            let h = '';
            cats.forEach(c => {
                const label = currentLang === 'ru' ? c.ru : c.name;
                h += `<div style="margin-bottom:10px;"><div class="worker-cat-row"><span>${label} (<span style="color:gold">${u[c.f]||0} ${c.u}</span>)</span><button class="btn-panel-gold btn-small" style="padding:4px 12px; font-weight:900; font-size:10px; border-radius:4px; border:none;" onclick="toggleCalc('${c.id}')">${translations[currentLang].btn_select}</button></div>
                    <div id="calc-${c.id}" class="calc-panel-inline"><input type="number" id="inp-${c.id}" class="calc-input" placeholder="0">
                    <button class="btn-icon-action btn-green" onclick="updateWorkerStat('${c.f}', '${c.id}', 1)">‚úî</button>
                    <button class="btn-icon-action btn-red" onclick="updateWorkerStat('${c.f}', '${c.id}', -1)">‚úñ</button></div></div>`;
            });
            document.getElementById('we-content').innerHTML = h;
            showScreen('worker-edit-screen', 'var(--bg-main)');
        }

        function openWorkerClocks(id) {
            currentWorkerId = id;
            isAdminViewing = true;
            const u = dbUsers.find(x => x.external_id == id);
            document.getElementById('clocks-panel-title').innerText = (currentLang === 'ru' ? "–§–∏—Ä–º—ã: " : "Firmy: ") + u.login;
            document.getElementById('clocks-header-controls').style.display = 'none';
            document.getElementById('clocks-back-btn').onclick = () => { isAdminViewing = false; showScreen('workers-screen'); };
            renderFirms();
            showScreen('clocks-screen', 'var(--bg-main)');
        }

        function openWorkerProfile(id) {
            currentWorkerId = id;
            isAdminViewing = true;
            const u = dbUsers.find(x => x.external_id == id);
            document.getElementById('prof-screen-title').innerText = (currentLang === 'ru' ? "–ü—Ä–æ—Ñ–∏–ª—å: " : "Profil: ") + u.login;
            document.getElementById('prof-fname').value = u.first_name || "";
            document.getElementById('prof-lname').value = u.last_name || "";
            document.getElementById('prof-login').value = u.login || "";
            document.getElementById('prof-dob').value = u.dob || "";
            document.getElementById('prof-workdate').value = u.work_date || "";
            document.getElementById('prof-id').value = u.external_id || "";
            document.getElementById('prof-back-btn').onclick = () => { isAdminViewing = false; showScreen('workers-screen'); };
            showScreen('profile-screen', 'var(--bg-main)');
        }

        function toggleCalc(id) { document.querySelectorAll('.calc-panel-inline').forEach(el => el.classList.remove('active')); document.getElementById('calc-'+id).classList.add('active'); }

        async function updateWorkerStat(field, inpId, mul) {
            const rawAmt = parseFloat(document.getElementById('inp-'+inpId).value); 
            if(!rawAmt) return;
            const amt = Math.abs(rawAmt); 
            const u = dbUsers.find(x => x.external_id == currentWorkerId);
            const newVal = (parseFloat(u[field])||0) + (amt * mul); 
            u[field] = newVal < 0 ? 0 : newVal;
            openWorkerAccount(currentWorkerId);
            await supabaseClient.from('profiles').update({ [field]: u[field] }).eq('external_id', currentWorkerId);
        }

        function hideKeyboard(e) { if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'SELECT') { document.activeElement.blur(); } }

        window.onload = initApp;
    </script>
</body>
</html>
