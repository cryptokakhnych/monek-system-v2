<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Monek System v4.2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --gold: #ffcc33;
            --dark-overlay: rgba(10, 10, 10, 0.96);
            --row-even: rgba(255, 255, 255, 0.03);
            --bg-main: url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/BEE1273C-8A49-4B01-B2D5-31E01244A38C.png');
            --bg-loader: url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/DE0BFEBD-58A8-4CA4-A803-10BDD5E177A2.png');
            --bg-menu: url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/F4AAC9F1-4AFA-411A-8D97-82C5F86FE825.png');
            --bg-hours: url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/2A2B5DCA-E3CC-4307-AA90-BEC512A1BC8A.png');
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none;
        }

        input { -webkit-user-select: text; user-select: text; }

        body, html {
            width: 100%; height: 100%; background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
        }

        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1; }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .canvas {
            position: relative; width: 100%; height: 100%;
            background-size: 100% 100%; background-position: center top; background-repeat: no-repeat;
            display: flex; flex-direction: column; align-items: center;
            animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        #loader-screen .canvas { background-image: var(--bg-loader) !important; }
        #menu-screen .canvas { background-image: var(--bg-menu) !important; }
        #hours-screen .canvas { background-image: var(--bg-hours) !important; }
        #advances-screen .canvas, #dayoff-screen .canvas, #shop-screen .canvas, 
        #profile-screen .canvas, #clocks-screen .canvas, #account-screen .canvas, 
        #top-screen .canvas, #workers-screen .canvas { background-image: var(--bg-main) !important; }

        .loader-content { position: absolute; top: 46%; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .progress-container { width: 60%; height: 14px; background: rgba(0,0,0,0.6); border-radius: 20px; border: 2px solid rgba(255,255,255,0.4); overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ffcc33, #ff6600); }
        
        #loading-text { color: var(--gold); font-size: 20px; margin-top: 12px; font-weight: 900; -webkit-text-stroke: 1.2px black; text-shadow: 2px 2px 0px rgba(0,0,0,1); }

        /* Контейнер для Счета на верхней доске */
        .top-board-container { 
            position: absolute; top: 22%; width: 100%; display: flex; justify-content: center; z-index: 10; 
        }

        .menu-grid {
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(4, 1fr);
            width: 86%; height: 50%; margin-top: 52%; gap: 2%;
        }
        .menu-item { display: flex; justify-content: center; align-items: center; }
        .menu-icon { width: 84%; max-width: 130px; cursor: pointer; transition: transform 0.1s; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); }
        .menu-icon:active { transform: scale(0.95); }
        
        /* Позиционирование */
        #open-account { width: 130px; transform: translateY(-5px); } /* Иконка Счета сверху */
        #open-profile { width: 110px; transform: translate(-80px, 210px); } 
        #open-advances { transform: translate(5px, 33px); }   
        #open-clocks { transform: translate(-5px, -150px); }
        #open-shop { transform: translate(5px, -50px); } 
        #open-top { transform: translate(-5px, -120px); } 
        #open-dayoff { transform: translate(-5px, -132px); } 
        #open-workers { transform: translate(5px, -300px); }

        /* Общие стили панелей */
        .panel-container {
            width: 78%; background: var(--dark-overlay);
            border: 1px solid var(--gold); border-radius: 12px;
            padding: 12px; display: flex; flex-direction: column;
            align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.9);
        }
        .panel-title { color: var(--gold); font-weight: 900; text-transform: uppercase; margin-bottom: 10px; font-size: 13px; letter-spacing: 1px; }
        .panel-input {
            width: 100%; padding: 10px; margin-bottom: 8px;
            border: 1px solid rgba(255,204,51,0.4); background: rgba(0,0,0,0.3);
            color: white; border-radius: 8px; text-align: center; font-size: 13px;
        }
        .btn-panel { width: 100%; padding: 11px; margin-top: 6px; border-radius: 8px; font-weight: 900; text-transform: uppercase; font-size: 12px; cursor: pointer; border: none; }
        .btn-panel-gold { background: linear-gradient(180deg, #ffcc33 0%, #ff9900 100%); color: #000; }
        .btn-panel-outline { background: transparent; border: 1px solid var(--gold); color: var(--gold); }

        /* Специфические отступы панелей */
        .acc-panel { margin-top: 54%; width: 78%; } 
        .account-stats { width: 100%; margin-bottom: 10px; }
        .stat-row { display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .stat-label { color: #aaa; font-size: 11px; }
        .stat-value { color: var(--gold); font-weight: bold; font-size: 11px; }
        
        .top-panel { margin-top: 57%; width: 75%; height: 300px; padding: 10px; justify-content: flex-start; }
        .top-tabs { display: flex; width: 100%; gap: 6px; margin-bottom: 8px; }
        .tab-btn { flex: 1; padding: 8px 2px; background: rgba(255,255,255,0.05); border: 1px solid var(--gold); color: var(--gold); border-radius: 6px; font-weight: 900; font-size: 9px; text-transform: uppercase; }
        .tab-btn.active { background: var(--gold); color: black; }
        .leaderboard-box { width: 100%; flex-grow: 1; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 6px; }
        .leaderboard-table { width: 100%; border-collapse: separate; border-spacing: 0 2px; color: white; font-size: 10px; }
        .leaderboard-table th { padding: 6px 2px; color: var(--gold); text-transform: uppercase; font-size: 8px; border-bottom: 1px solid rgba(255,204,51,0.2); }
        .leaderboard-table td { padding: 6px 2px; text-align: center; background: rgba(255,255,255,0.02); }
        .total-summary { width: 100%; padding: 8px; margin: 4px 0; background: rgba(255,204,51,0.12); border-radius: 6px; color: var(--gold); font-size: 13px; text-align: center; font-weight: 900; border: 1px dashed var(--gold); text-shadow: 0 0 5px rgba(0,0,0,0.5); }

        .shop-panel { margin-top: 56%; width: 75%; }
        .shop-row { display:flex; justify-content:space-between; align-items: center; width:100%; margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:5px; }
        .shop-info { display: flex; flex-direction: column; text-align: left; flex: 1; }
        .shop-item-name { color:var(--gold); font-size:12px; font-weight: bold; }
        .shop-item-price { color:#888; font-size: 9px; }
        .shop-item-total { color: var(--gold); font-size: 9px; margin-top: 2px; font-weight: bold; }

        .clocks-panel { margin-top: 62%; width: 76%; padding: 15px; }
        .clocks-header-row { display: flex; width: 100%; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--gold); }
        .clocks-title-text { color: var(--gold); font-weight: 900; font-size: 16px; text-transform: uppercase; }
        .clocks-btns-top { display: flex; gap: 8px; }
        .btn-round { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--gold); background: rgba(255,204,51,0.1); color: var(--gold); display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; }
        .clocks-list-box { width: 100%; max-height: 180px; overflow-y: auto; margin-bottom: 10px; }
        .firm-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: white; font-size: 14px; }
        .btn-select-firm { background: var(--gold); color: black; border: none; padding: 6px 12px; border-radius: 6px; font-weight: bold; font-size: 11px; text-transform: uppercase; }
        .btn-del-firm { background: #ff4444; color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 11px; }

        .hours-unified-panel { width: 80%; margin-top: 15%; background: var(--dark-overlay); border: 2px solid var(--gold); border-radius: 15px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,1); }
        .hours-header-unified { background: linear-gradient(180deg, rgba(255,204,51,0.2) 0%, rgba(0,0,0,0) 100%); padding: 15px; text-align: center; border-bottom: 1px solid var(--gold); }
        .hours-title-unified { color: var(--gold); font-weight: 900; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }
        .table-scroll-container { height: 370px; overflow-y: auto; background: transparent; }
        .hours-table-main { width: 100%; border-collapse: collapse; color: white; font-size: 12px; }
        .hours-table-main th { position: sticky; top: 0; background: var(--gold); color: black; padding: 10px 2px; z-index: 2; font-weight: 900; font-size: 10px; }
        .hours-table-main td { border-bottom: 1px solid rgba(255,255,255,0.08); padding: 6px 2px; text-align: center; }
        .hour-input-cell { width: 90%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,204,51,0.2); color: white; text-align: center; padding: 5px 0; border-radius: 4px; font-size: 12px; }
        .hours-footer-unified { padding: 12px; background: rgba(0,0,0,0.5); border-top: 1px solid var(--gold); }
        .total-hours-row { color: var(--gold); font-weight: 900; text-align: right; padding-bottom: 10px; font-size: 15px; border-bottom: 1px dashed rgba(255,204,51,0.3); margin-bottom: 10px; }
        .beautiful-btns-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-beaut { padding: 11px; border-radius: 8px; font-weight: 900; text-transform: uppercase; font-size: 10px; border: none; cursor: pointer; box-shadow: 0 3px 0 rgba(0,0,0,0.2); transition: all 0.1s; }
        .btn-beaut:active { transform: translateY(2px); box-shadow: none; }
        .btn-send-gold { background: linear-gradient(180deg, #ffcc33 0%, #ff9900 100%); color: #000; }
        .btn-save-green { background: linear-gradient(180deg, #4CAF50 0%, #2e7d32 100%); color: #fff; }
        .btn-clear-red { background: linear-gradient(180deg, #f44336 0%, #c62828 100%); color: #fff; }
        .btn-back-black { background: rgba(255,255,255,0.1); border: 1px solid var(--gold); color: var(--gold); }

        .profile-panel { margin-top: 56%; width: 72%; }
        .adv-panel, .dayoff-panel { margin-top: 60%; width: 75%; }

        .workers-panel { margin-top: 57%; width: 75%; height: 320px; padding: 12px; justify-content: flex-start; }
        .workers-list-box { width: 100%; flex-grow: 1; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 6px; }
        .worker-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 8px; border-bottom: 1px solid rgba(255,204,51,0.1); }
        .worker-name { color: white; font-size: 12px; font-weight: bold; }
        .btn-select-worker { background: var(--gold); color: black; border: none; padding: 5px 10px; border-radius: 4px; font-weight: 900; font-size: 9px; text-transform: uppercase; }
    </style>
</head>
<body onclick="hideKeyboard(event)">

    <div id="loader-screen" class="screen" style="display: block;">
        <div class="canvas">
            <div class="loader-content">
                <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
                <div id="loading-text">0%</div>
            </div>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <div class="canvas">
            <div class="top-board-container">
                <img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/96CCD0ED-D67B-4AD3-823E-35FD2BECCAB2.png" class="menu-icon" id="open-account">
            </div>

            <div class="profile-top-container">
                <img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/D6D08605-797C-407A-AC9F-CA1D85241C3A.png" class="menu-icon" id="open-profile" style="position: relative;">
            </div>

            <div class="menu-grid">
                <div class="menu-item"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/9B30F657-53D7-4158-91D6-5F004D6E3D19.png" class="menu-icon" id="open-advances"></div>
                <div class="menu-item"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/8CF47A13-928B-47FC-9494-D6354E56BB25.png" class="menu-icon" id="open-clocks"></div>
                <div class="menu-item"></div> <div class="menu-item"></div> <div class="menu-item"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/6E3CA577-B227-4A8B-9929-A020B6B6AF5C.png" class="menu-icon" id="open-shop"></div>
                <div class="menu-item"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/1656CF23-37C3-4E2D-B9B5-7A86688E4DC0.png" class="menu-icon" id="open-top"></div>
                <div class="menu-item"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/F0374C7C-C546-4CF7-8BCD-3E8137BEC8EA.png" class="menu-icon" id="open-workers"></div>
                <div class="menu-item"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/EBD0902B-4CCD-44C4-94FD-C5CF1E27F3F5.png" class="menu-icon" id="open-dayoff"></div>
            </div>
        </div>
    </div>

    <div id="workers-screen" class="screen"><div class="canvas"><div class="panel-container workers-panel"><div class="panel-title">Работники</div><div id="workers-list-container" class="workers-list-box"></div><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>
    <div id="account-screen" class="screen"><div class="canvas"><div class="panel-container acc-panel"><div class="panel-title">Счет</div><div class="account-stats"><div class="stat-row"><span class="stat-label">Зарплата:</span><span id="acc-salary" class="stat-value">0 CZK</span></div><div class="stat-row"><span class="stat-label">Авансы кроны:</span><span id="acc-adv-czk" class="stat-value">0 CZK</span></div><div class="stat-row"><span class="stat-label">Авансы евро:</span><span id="acc-adv-eur" class="stat-value">0 EUR</span></div><div class="stat-row"><span class="stat-label">Штрафы:</span><span id="acc-fines" class="stat-value">0 CZK</span></div><div class="total-summary" style="margin-top:10px; border-style: solid; height: auto; padding: 12px;"><div style="font-size: 9px; margin-bottom: 4px;">К ВЫДАЧЕ:</div><div id="acc-total-payout" style="font-size: 11px; font-weight: 900;">0 CZK 0 EUR</div></div></div><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>
    <div id="top-screen" class="screen"><div class="canvas"><div class="panel-container top-panel"><div class="panel-title">ТОП</div><div class="top-tabs"><button class="tab-btn active" id="tab-adv" onclick="switchTop('adv')">Топ авансов</button><button class="tab-btn" id="tab-exp" onclick="switchTop('exp')">Топ стаж</button></div><div class="leaderboard-box"><table class="leaderboard-table"><thead id="top-header"></thead><tbody id="top-body"></tbody></table></div><div id="advances-total" class="total-summary">Всего: 0€ | 0 CZK</div><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>
    <div id="profile-screen" class="screen"><div class="canvas"><div class="panel-container profile-panel"><div class="panel-title">Профиль</div><input type="text" id="prof-login" class="panel-input" placeholder="Логин"><input type="text" id="prof-dob" class="panel-input" placeholder="Дата рождения (ДД-ММ-ГГГГ)"><input type="text" id="prof-workdate" class="panel-input" placeholder="Дата начала (ДД-ММ-ГГГГ)"><input type="text" id="prof-id" class="panel-input" placeholder="ID"><button class="btn-panel btn-panel-gold" onclick="submitProfile()">СОХРАНИТЬ</button><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>
    <div id="advances-screen" class="screen"><div class="canvas"><div class="panel-container adv-panel"><div class="panel-title">Аванс</div><select id="adv-currency" class="panel-input" style="background: rgba(0,0,0,0.5); color: gold;"><option value="CZK">CZK</option><option value="EUR">EUR</option></select><input type="number" id="adv-amount" class="panel-input" placeholder="Сумма"><input type="text" id="adv-reason" class="panel-input" placeholder="Причина"><button class="btn-panel btn-panel-gold" onclick="submitAdvances()">ОТПРАВИТЬ</button><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>
    <div id="dayoff-screen" class="screen"><div class="canvas"><div class="panel-container dayoff-panel"><div class="panel-title">Выходной</div><input type="text" id="dayoff-date" class="panel-input" placeholder="Дата"><input type="text" id="dayoff-reason" class="panel-input" placeholder="Причина"><button class="btn-panel btn-panel-gold" onclick="submitDayOff()">ОТПРАВИТЬ</button><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>
    <div id="shop-screen" class="screen"><div class="canvas"><div class="panel-container shop-panel"><div class="panel-title">Магазин</div><div class="shop-row"><div class="shop-info"><span class="shop-item-name">Сахарок</span><span class="shop-item-price">200 CZK/ед.</span><span id="sugar-item-total" class="shop-item-total">Итого: 0 CZK</span></div><input type="number" id="qty-sugar" class="panel-input" style="width:55px; margin:0;" placeholder="0" oninput="calculateShop()"></div><div class="shop-row"><div class="shop-info"><span class="shop-item-name">Зеленая</span><span class="shop-item-price">150 CZK/ед.</span><span id="green-item-total" class="shop-item-total">Итого: 0 CZK</span></div><input type="number" id="qty-green" class="panel-input" style="width:55px; margin:0;" placeholder="0" oninput="calculateShop()"></div><div style="width:100%; text-align:right; color:var(--gold); font-weight:900; margin: 10px 0;">ИТОГО: <span id="grand-total">0</span> CZK</div><button class="btn-panel btn-panel-gold" onclick="submitShopOrder()">ЗАКАЗАТЬ</button><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>
    <div id="clocks-screen" class="screen"><div class="canvas"><div class="panel-container clocks-panel"><div class="clocks-header-row"><span class="clocks-title-text">Мои фирмы</span><div class="clocks-btns-top"><div class="btn-round" onclick="addFirm()">+</div><div class="btn-round" id="btn-toggle-delete" onclick="toggleDeleteMode()">−</div></div></div><div id="firm-list-container" class="clocks-list-box"></div><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>
    <div id="hours-screen" class="screen"><div class="canvas"><div class="hours-unified-panel"><div class="hours-header-unified"><div id="current-firm-name" class="hours-title-unified">ФИРМА</div></div><div class="table-scroll-container"><table class="hours-table-main"><thead><tr><th>Д</th><th>ОТ</th><th>ДО</th><th>Ч</th><th>ОБЪЕКТ</th></tr></thead><tbody id="hours-tbody"></tbody></table></div><div class="hours-footer-unified"><div class="total-hours-row">ИТОГО: <span id="table-total-val">0</span> ЧАСОВ</div><div class="beautiful-btns-grid"><button class="btn-beaut btn-send-gold" onclick="sendHoursReport()">Отправить</button><button class="btn-beaut btn-save-green" onclick="saveHoursData()">Сохранить</button><button class="btn-beaut btn-clear-red" onclick="clearHoursData()">Очистить</button><button class="btn-beaut btn-back-black" onclick="closeHoursScreen()">Назад</button></div></div></div></div></div>

    <script>
        const SUPABASE_URL = 'https://mnexoturnujxjjicfukc.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uZXhvdHVybnVqeGpqaWNmdWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MTY1MzksImV4cCI6MjA4NTA5MjUzOX0.Ye4PJuEpuyLLRACkv72tvf0mh7IBn7JYRA8OJ1kLrc0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let dbUsers = [];
        const RATE = 24.2;

        function formatToDMY(s) { if(!s) return ""; let d = new Date(s); return isNaN(d) ? s : d.toLocaleDateString('ru-RU').replace(/\./g, '-'); }
        function parseDMY(s) { if(!s) return null; s = s.replace(/\./g, '-'); if(s.includes('-')) { let p = s.split('-'); if(p[0].length === 2) return `${p[2]}-${p[1]}-${p[0]}`; return s; } return s; }

        async function initApp() {
            document.querySelectorAll('.canvas').forEach(c => c.style.height = window.innerHeight + 'px');
            renderFirms(); generateDaysTable(); await loadProfileData(); await fetchLeaderboardData();
            const bar = document.getElementById('progress-bar');
            const txt = document.getElementById('loading-text');
            let start = Date.now(), dur = 1500;
            const frame = () => {
                let pct = Math.min(((Date.now()-start)/dur)*100, 100);
                bar.style.width = pct+'%'; txt.innerText = Math.floor(pct)+'%';
                if(pct < 100) requestAnimationFrame(frame);
                else setTimeout(() => showScreen('menu-screen'), 300);
            };
            requestAnimationFrame(frame);
        }

        async function fetchLeaderboardData() {
            try {
                const { data, error } = await supabaseClient.from('profiles').select('*');
                if (error) throw error;
                dbUsers = data.map(u => ({
                    login: u.login || "Без имени",
                    external_id: String(u.external_id || ""),
                    workDate: u.work || null, 
                    advEur: Number(u.advEur || 0), 
                    advCzk: Number(u.advCzk || 0), 
                    fines: Number(u.fines || 0),
                    salary: Number(u.salary || 0)
                }));
                updateAccountStats();
                renderWorkersList();
            } catch (e) { console.error("Data load error", e); }
        }

        function updateAccountStats() {
            const myId = String(document.getElementById('prof-id').value || localStorage.getItem('last_id') || "").trim();
            const u = dbUsers.find(x => x.external_id === myId);
            if (u) {
                // Авансы всегда отрицательные для корректного вычета
                const dCzk = u.advCzk > 0 ? -u.advCzk : u.advCzk;
                const dEur = u.advEur > 0 ? -u.advEur : u.advEur;
                document.getElementById('acc-salary').innerText = u.salary + " CZK";
                document.getElementById('acc-adv-czk').innerText = dCzk + " CZK";
                document.getElementById('acc-adv-eur').innerText = dEur + " EUR";
                document.getElementById('acc-fines').innerText = u.fines + " CZK";
                let finalCzk = u.salary + dCzk + u.fines;
                let finalEur = dEur;
                document.getElementById('acc-total-payout').innerText = `${finalCzk} CZK ${finalEur} EUR`;
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'top-screen') switchTop('adv');
            if(id === 'account-screen' || id === 'workers-screen') fetchLeaderboardData();
        }

        function switchTop(mode) {
            const h = document.getElementById('top-header'), b = document.getElementById('top-body'), t = document.getElementById('advances-total');
            document.getElementById('tab-exp').classList.toggle('active', mode==='exp');
            document.getElementById('tab-adv').classList.toggle('active', mode==='adv');
            b.innerHTML = "";
            if(mode==='exp') {
                t.style.display = "none"; h.innerHTML = `<tr><th>Поз.</th><th>Имя</th><th>Дни</th></tr>`;
                let sorted = dbUsers.map(u => {
                    let dStr = parseDMY(u.workDate);
                    let d = dStr ? new Date(dStr) : null;
                    let daysCount = (d && !isNaN(d)) ? Math.floor((new Date() - d) / 86400000) : 0;
                    return {...u, days: Math.max(0, daysCount)};
                }).sort((a,b) => b.days - a.days);
                sorted.forEach((u,i) => { b.innerHTML += `<tr><td>${i+1}</td><td>${u.login}</td><td>${u.days} дн.</td></tr>`; });
            } else {
                t.style.display = "block"; h.innerHTML = `<tr><th>Поз.</th><th>Имя</th><th>EUR</th><th>CZK</th></tr>`;
                let sorted = [...dbUsers].sort((a,b) => ((Math.abs(b.advEur)*RATE)+Math.abs(b.advCzk)) - ((Math.abs(a.advEur)*RATE)+Math.abs(a.advCzk)));
                let sE=0, sC=0;
                sorted.forEach((u,i) => { 
                    sE+=Math.abs(u.advEur); sC+=Math.abs(u.advCzk); 
                    b.innerHTML += `<tr><td>${i+1}</td><td>${u.login}</td><td>${Math.abs(u.advEur)}€</td><td>${Math.abs(u.advCzk)}</td></tr>`; 
                });
                t.innerText = `Всего: ${sE}€ | ${sC} CZK`;
            }
        }

        // Остальные функции (фирмы, часы, магазин, профиль)
        let firms = JSON.parse(localStorage.getItem('monek_firms')) || ["Monek Group"];
        let isDel = false;
        function renderFirms() {
            const c = document.getElementById('firm-list-container'); if(!c) return;
            c.innerHTML = ''; firms.forEach((f, i) => {
                c.innerHTML += `<div class="firm-row"><span>${f}</span><div style="display:flex; gap:5px;">${isDel ? `<button class="btn-del-firm" onclick="delFirm(${i})">Удалить</button>` : `<button class="btn-select-firm" onclick="openHours('${f}')">Выбрать</button>`}</div></div>`;
            });
            localStorage.setItem('monek_firms', JSON.stringify(firms));
        }
        function addFirm() { let n = prompt("Название фирмы:"); if(n) {firms.push(n); renderFirms();} }
        function delFirm(i) { firms.splice(i,1); isDel = false; renderFirms(); }
        function toggleDeleteMode() { isDel = !isDel; renderFirms(); }
        function generateDaysTable() { const b = document.getElementById('hours-tbody'); if(!b) return; b.innerHTML = ''; for(let i=1; i<=31; i++) b.innerHTML += `<tr><td>${i}</td><td><input type="number" class="hour-input-cell inp-f" oninput="calcH(this)"></td><td><input type="number" class="hour-input-cell inp-t" oninput="calcH(this)"></td><td class="res-h">0</td><td><input type="text" class="hour-input-cell inp-s"></td></tr>`; }
        let curF = "";
        function openHours(f) { curF = f; document.getElementById('current-firm-name').innerText = f; loadHours(); showScreen('hours-screen'); }
        function closeHoursScreen() { showScreen('clocks-screen'); }
        function calcH(el) { const tr = el.closest('tr'); const f = parseFloat(tr.querySelector('.inp-f').value), t = parseFloat(tr.querySelector('.inp-t').value), r = tr.querySelector('.res-h'); if(f && t && t>f) { let h = (t-f)-0.5; r.innerText = h<0 ? 0 : h; } else r.innerText = "0"; let total = 0; document.querySelectorAll('.res-h').forEach(td => total += parseFloat(td.innerText)||0); document.getElementById('table-total-val').innerText = total; }
        async function saveHoursData() { const data = Array.from(document.querySelectorAll('#hours-tbody tr')).map(tr => ({ f: tr.querySelector('.inp-f').value, t: tr.querySelector('.inp-t').value, h: tr.querySelector('.res-h').innerText, s: tr.querySelector('.inp-s').value })); localStorage.setItem('h_'+curF, JSON.stringify(data)); const id = document.getElementById('prof-id').value || "guest"; await supabaseClient.from('work_hours').upsert({ external_id: id+"_"+curF, user_id: id, firm_name: curF, hours_json: data }, { onConflict: 'external_id' }); alert("Сохранено!"); }
        async function loadHours() { const local = JSON.parse(localStorage.getItem('h_'+curF)) || []; applyHoursToTable(local); const id = document.getElementById('prof-id').value || localStorage.getItem('last_id'); if(id) { const { data } = await supabaseClient.from('work_hours').select('hours_json').eq('external_id', id+"_"+curF).maybeSingle(); if(data) applyHoursToTable(data.hours_json); } }
        function applyHoursToTable(d) { const rows = document.querySelectorAll('#hours-tbody tr'); rows.forEach((tr, i) => { tr.querySelector('.inp-f').value = d[i]?.f||''; tr.querySelector('.inp-t').value = d[i]?.t||''; tr.querySelector('.res-h').innerText = d[i]?.h||'0'; tr.querySelector('.inp-s').value = d[i]?.s||''; }); let tot = 0; document.querySelectorAll('.res-h').forEach(td => tot += parseFloat(td.innerText)||0); document.getElementById('table-total-val').innerText = tot; }
        function clearHoursData() { if(confirm("Очистить?")) { localStorage.removeItem('h_'+curF); applyHoursToTable([]); } }
        async function sendHoursReport() { const id = document.getElementById('prof-id').value || localStorage.getItem('last_id'); applyHoursToTable([]); localStorage.removeItem('h_'+curF); if(id) await supabaseClient.from('work_hours').delete().eq('external_id', id + "_" + curF); alert("Таблица отправлена!"); closeHoursScreen(); }
        function calculateShop() { let s = Math.max(0, parseInt(document.getElementById('qty-sugar').value)||0), g = Math.max(0, parseInt(document.getElementById('qty-green').value)||0); document.getElementById('sugar-item-total').innerText = "Итого: "+(s*200)+" CZK"; document.getElementById('green-item-total').innerText = "Итого: "+(g*150)+" CZK"; document.getElementById('grand-total').innerText = (s*200 + g*150); }
        function submitShopOrder() { alert("Заказ оформлен!"); backToMenu(); }
        async function submitProfile() { const idVal = String(document.getElementById('prof-id').value).trim(); const p = { login: document.getElementById('prof-login').value, dob: parseDMY(document.getElementById('prof-dob').value), work: parseDMY(document.getElementById('prof-workdate').value), external_id: idVal }; localStorage.setItem('monek_prof', JSON.stringify(p)); localStorage.setItem('last_id', idVal); await supabaseClient.from('profiles').upsert([p], { onConflict: 'external_id' }); await fetchLeaderboardData(); alert("Профиль обновлен!"); backToMenu(); }
        async function loadProfileData() { let p = JSON.parse(localStorage.getItem('monek_prof')); if(p) fillFields(p); let id = p?.external_id || localStorage.getItem('last_id'); if(id) { const { data } = await supabaseClient.from('profiles').select('*').eq('external_id', String(id)).maybeSingle(); if(data) fillFields(data); } }
        function fillFields(o) { document.getElementById('prof-login').value = o.login||""; document.getElementById('prof-dob').value = formatToDMY(o.dob)||""; document.getElementById('prof-workdate').value = formatToDMY(o.work)||""; document.getElementById('prof-id').value = o.external_id||""; }
        async function submitAdvances() { const id = localStorage.getItem('last_id'); const amt = document.getElementById('adv-amount').value; if(!amt) return alert("Введите сумму"); await supabaseClient.from('advances').insert([{ user_id: id, amount: amt, currency: document.getElementById('adv-currency').value, reason: document.getElementById('adv-reason').value }]); alert("Запрос отправлен!"); backToMenu(); }
        async function submitDayOff() { const id = localStorage.getItem('last_id'); const date = document.getElementById('dayoff-date').value; if(!date) return alert("Введите дату"); await supabaseClient.from('dayoffs').insert([{ user_id: id, date: date, reason: document.getElementById('dayoff-reason').value }]); alert("Запрос отправлен!"); backToMenu(); }
        function backToMenu() { document.querySelectorAll('.adv-panel input, .dayoff-panel input, .shop-panel input').forEach(i => i.value=""); calculateShop(); showScreen('menu-screen'); }
        function hideKeyboard(e) { if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') document.activeElement.blur(); }
        function renderWorkersList() {
            const container = document.getElementById('workers-list-container'); if (!container) return; container.innerHTML = "";
            dbUsers.filter(u => u.login !== "Без имени").forEach(worker => {
                const div = document.createElement('div'); div.className = "worker-item";
                div.innerHTML = `<span class="worker-name">${worker.login}</span><button class="btn-select-worker" onclick="alert('ID: ${worker.external_id}')">Выбрать</button>`;
                container.appendChild(div);
            });
        }

        window.onload = initApp;
        document.getElementById('open-profile').onclick = () => showScreen('profile-screen');
        document.getElementById('open-advances').onclick = () => showScreen('advances-screen');
        document.getElementById('open-clocks').onclick = () => showScreen('clocks-screen');
        document.getElementById('open-top').onclick = () => showScreen('top-screen');
        document.getElementById('open-dayoff').onclick = () => showScreen('dayoff-screen');
        document.getElementById('open-shop').onclick = () => showScreen('shop-screen');
        document.getElementById('open-account').onclick = () => showScreen('account-screen');
        document.getElementById('open-workers').onclick = () => showScreen('workers-screen');
    </script>
</body>
</html>
