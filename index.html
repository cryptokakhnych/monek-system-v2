<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monek System v3.7</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* =========================================
           ОСНОВНЫЕ НАСТРОЙКИ (RESET)
           ========================================= */
        :root {
            --gold: #ffcc33;
            --danger: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: white;
            overflow: hidden; /* Запрещаем скролл самого body */
        }

        /* =========================================
           ЭКРАНЫ И ФОНЫ (СТАРАЯ ФОРМА)
           ========================================= */
        .screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow-y: auto; /* Скролл только внутри экрана */
            -webkit-overflow-scrolling: touch;
        }

        /* Возвращаем индивидуальные фоны как были */
        #loader-screen { background-image: url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/DE0BFEBD-58A8-4CA4-A803-10BDD5E177A2.png'); }
        #menu-screen { background-image: url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/F4AAC9F1-4AFA-411A-8D97-82C5F86FE825.png'); }
        #hours-screen { background-image: url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/2A2B5DCA-E3CC-4307-AA90-BEC512A1BC8A.png'); }
        /* Остальные экраны используют общий темный фон с картинкой */
        #profile-screen, #advances-screen, #dayoff-screen, #shop-screen, #top-screen, #account-screen, #clocks-screen {
            background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/BEE1273C-8A49-4B01-B2D5-31E01244A38C.png');
        }

        .content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            min-height: 101%; /* Чтобы скролл всегда был активен */
            padding-bottom: 50px;
        }

        /* =========================================
           ШКАЛА ЗАГРУЗКИ (КАК БЫЛА)
           ========================================= */
        .loader-container {
            margin-top: 130%; /* Позиция шкалы */
            width: 70%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .old-progress-bg {
            width: 100%;
            height: 12px;
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--gold);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(255, 204, 51, 0.3);
        }

        .old-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ffcc33, #ff9900);
            transition: width 0.1s;
        }

        /* =========================================
           МЕНЮ И ЭЛЕМЕНТЫ
           ========================================= */
        .profile-btn { width: 130px; margin-top: 30px; cursor: pointer; }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 85%;
            margin-top: 110%; /* Смещение сетки вниз */
        }

        .icon-btn { width: 100%; cursor: pointer; transition: 0.1s; }
        .icon-btn:active { transform: scale(0.95); }

        /* Специфические смещения иконок из ТЗ */
        #btn-advances { transform: translate(5px, 10px); }
        #btn-dayoff { transform: translate(-5px, -27px); }
        #btn-account { transform: translate(5px, -27px); }

        /* ПАНЕЛИ */
        .glass-panel {
            width: 90%;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--gold);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .title { color: var(--gold); font-weight: 900; text-align: center; margin-bottom: 20px; text-transform: uppercase; }

        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 12px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,204,51,0.3);
            color: #fff; border-radius: 8px; font-size: 14px; outline: none;
        }

        .btn {
            width: 100%; padding: 15px; border-radius: 8px; border: none;
            font-weight: 900; text-transform: uppercase; cursor: pointer;
        }
        .btn-gold { background: linear-gradient(180deg, #ffcc33, #ff9900); color: #000; }
        .btn-back { background: transparent; border: 1px solid var(--gold); color: var(--gold); margin-top: 10px; }

        /* ТАБЛИЦА ЧАСОВ */
        .hours-box { width: 95%; margin-top: 25%; background: rgba(10,10,10,0.95); border: 1px solid var(--gold); border-radius: 10px; }
        .scroll-area { height: 320px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: var(--gold); color: #000; padding: 10px 2px; position: sticky; top: 0; }
        td { text-align: center; padding: 8px 2px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .h-input { width: 35px; background: none; border: 1px solid #444; color: #fff; text-align: center; padding: 4px; margin: 0; }
        .obj-input { width: 90%; background: none; border: 1px solid #444; color: #fff; padding: 4px; }

        /* ФИНАНСЫ */
        .row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .val { color: var(--gold); font-weight: bold; }
        .minus { color: var(--danger); }
        .total-res { background: rgba(255,204,51,0.1); padding: 15px; border-radius: 10px; text-align: center; margin-top: 15px; border: 1px dashed var(--gold); }
    </style>
</head>
<body>

    <div id="loader-screen" class="screen" style="display: block;">
        <div class="content">
            <div class="loader-container">
                <div class="old-progress-bg">
                    <div id="progress-bar" class="old-progress-fill"></div>
                </div>
                <div id="status-text" style="margin-top:10px; font-size:12px; color:var(--gold);">LOADING...</div>
            </div>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <div class="content">
            <img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/D6D08605-797C-407A-AC9F-CA1D85241C3A.png" class="profile-btn" id="go-profile">
            
            <div class="menu-grid">
                <img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/9B30F657-53D7-4158-91D6-5F004D6E3D19.png" class="icon-btn" id="btn-advances">
                <img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/8CF47A13-928B-47FC-9494-D6354E56BB25.png" class="icon-btn" id="btn-clocks">
                <img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/6E3CA577-B227-4A8B-9929-A020B6B6AF5C.png" class="icon-btn" id="btn-shop">
                <img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/1656CF23-37C3-4E2D-B9B5-7A86688E4DC0.png" class="icon-btn" id="btn-top">
                <img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/96CCD0ED-D67B-4AD3-823E-35FD2BECCAB2.png" class="icon-btn" id="btn-account">
                <img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/EBD0902B-4CCD-44C4-94FD-C5CF1E27F3F5.png" class="icon-btn" id="btn-dayoff">
            </div>
        </div>
    </div>

    <div id="profile-screen" class="screen">
        <div class="content">
            <div class="glass-panel" style="margin-top:60%;">
                <div class="title">Мой Профиль</div>
                <input type="text" id="p-login" placeholder="Логин/Имя">
                <input type="text" id="p-dob" placeholder="Дата рождения (ДД-ММ-ГГГГ)">
                <input type="text" id="p-work" placeholder="Дата начала работы (ДД-ММ-ГГГГ)">
                <input type="text" id="p-id" placeholder="Ваш ID">
                <button class="btn btn-gold" onclick="saveProfile()">Сохранить</button>
                <button class="btn btn-back" onclick="show('menu-screen')">Назад</button>
            </div>
        </div>
    </div>

    <div id="advances-screen" class="screen">
        <div class="content">
            <div class="glass-panel" style="margin-top:60%;">
                <div class="title">Заявка на аванс</div>
                <select id="adv-val">
                    <option value="CZK">CZK (Кроны)</option>
                    <option value="EUR">EUR (Евро)</option>
                </select>
                <input type="number" id="adv-sum" placeholder="Сумма">
                <input type="text" id="adv-txt" placeholder="Комментарий">
                <button class="btn btn-gold" onclick="sendReq('advances')">Отправить</button>
                <button class="btn btn-back" onclick="show('menu-screen')">Назад</button>
            </div>
        </div>
    </div>

    <div id="account-screen" class="screen">
        <div class="content">
            <div class="glass-panel" style="margin-top:65%;">
                <div class="title">Ваш баланс</div>
                <div class="row"><span>Зарплата:</span><span id="acc-sal" class="val">0 CZK</span></div>
                <div class="row"><span>Авансы CZK:</span><span id="acc-czk" class="val minus">0 CZK</span></div>
                <div class="row"><span>Авансы EUR:</span><span id="acc-eur" class="val minus">0 EUR</span></div>
                <div class="row"><span>Штрафы:</span><span id="acc-fin" class="val minus">0 CZK</span></div>
                
                <div class="total-res">
                    <div style="font-size:10px; color:#aaa; margin-bottom:5px;">ИТОГО К ВЫДАЧЕ:</div>
                    <div id="acc-total" style="font-size:18px; font-weight:bold; color:var(--gold);">0 CZK + 0 EUR</div>
                </div>
                <button class="btn btn-back" onclick="show('menu-screen')">Назад</button>
            </div>
        </div>
    </div>

    <div id="top-screen" class="screen">
        <div class="content">
            <div class="glass-panel" style="margin-top:60%;">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn btn-back" id="t-adv" style="margin:0; flex:1;" onclick="loadTop('adv')">Авансы</button>
                    <button class="btn btn-back" id="t-exp" style="margin:0; flex:1;" onclick="loadTop('exp')">Стаж</button>
                </div>
                <div style="max-height:280px; overflow-y:auto;">
                    <table id="top-list"></table>
                </div>
                <button class="btn btn-back" onclick="show('menu-screen')">Назад</button>
            </div>
        </div>
    </div>

    <div id="hours-screen" class="screen">
        <div class="content">
            <div class="hours-box">
                <div id="h-title" style="padding:10px; text-align:center; color:var(--gold); font-weight:bold; background:rgba(255,255,255,0.05);">ФИРМА</div>
                <div class="scroll-area">
                    <table id="h-table">
                        <thead><tr><th>Д</th><th>ОТ</th><th>ДО</th><th>Ч</th><th>ОБЪЕКТ</th></tr></thead>
                        <tbody id="h-body"></tbody>
                    </table>
                </div>
                <div style="padding:15px; border-top:1px solid var(--gold); display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:12px;">ИТОГО ЧАСОВ:</span>
                    <span id="h-sum" style="color:var(--gold); font-weight:900; font-size:18px;">0</span>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:10px;">
                    <button class="btn btn-gold" style="padding:10px;" onclick="saveHours(true)">Отправить</button>
                    <button class="btn btn-back" style="padding:10px; color:white; margin:0;" onclick="saveHours(false)">ОК</button>
                    <button id="h-reset" class="btn btn-back" style="grid-column: span 2; border-color:var(--danger); color:var(--danger); margin:0;">Сбросить данные</button>
                    <button class="btn btn-back" style="grid-column: span 2; margin:0;" onclick="show('clocks-screen')">Назад</button>
                </div>
            </div>
        </div>
    </div>

    <div id="clocks-screen" class="screen">
        <div class="content">
            <div class="glass-panel" style="margin-top:65%;">
                <div class="title" style="display:flex; justify-content:space-between;"><span>Фирмы</span><span onclick="addFirm()" style="cursor:pointer;">[+]</span></div>
                <div id="firm-list"></div>
                <button class="btn btn-back" onclick="show('menu-screen')">Назад</button>
            </div>
        </div>
    </div>

    <div id="dayoff-screen" class="screen">
        <div class="content">
            <div class="glass-panel" style="margin-top:60%;">
                <div class="title">Запрос выходного</div>
                <input type="text" id="do-date" placeholder="Дата (ДД-ММ-ГГГГ)">
                <textarea id="do-txt" placeholder="Причина"></textarea>
                <button class="btn btn-gold" onclick="sendReq('dayoffs')">Подать</button>
                <button class="btn btn-back" onclick="show('menu-screen')">Назад</button>
            </div>
        </div>
    </div>

    <script>
        // --- КОНФИГУРАЦИЯ ---
        const SB_URL = 'https://mnexoturnujxjjicfukc.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uZXhvdHVybnVqeGpqaWNmdWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MTY1MzksImV4cCI6MjA4NTA5MjUzOX0.Ye4PJuEpuyLLRACkv72tvf0mh7IBn7JYRA8OJ1kLrc0';
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        let activeFirm = "";
        let firms = JSON.parse(localStorage.getItem('m_firms')) || ["Monek Group"];

        // --- УТИЛИТЫ ---
        function show(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'account-screen') updateAcc();
            if(id === 'top-screen') loadTop('adv');
            if(id === 'clocks-screen') renderFirms();
        }

        function dToIso(d) { if(!d) return null; const p = d.split('-'); return `${p[2]}-${p[1]}-${p[0]}`; }
        function isoToD(iso) { if(!iso) return ""; const d = new Date(iso); return isNaN(d) ? iso : `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`; }

        // --- ИНИЦИАЛИЗАЦИЯ ---
        async function init() {
            createGrid();
            await loadProf();
            
            let p = 0;
            const bar = document.getElementById('progress-bar');
            const iv = setInterval(() => {
                p += Math.floor(Math.random() * 5) + 2;
                if(p > 100) p = 100;
                bar.style.width = p + "%";
                if(p === 100) { clearInterval(iv); show('menu-screen'); }
            }, 60);
        }

        // --- ПРОФИЛЬ ---
        async function loadProf() {
            const id = localStorage.getItem('m_id');
            if(id) {
                const { data } = await supabase.from('profiles').select('*').eq('external_id', id).maybeSingle();
                if(data) {
                    document.getElementById('p-login').value = data.login || "";
                    document.getElementById('p-dob').value = isoToD(data.dob);
                    document.getElementById('p-work').value = isoToD(data.work);
                    document.getElementById('p-id').value = data.external_id;
                }
            }
        }

        async function saveProfile() {
            const id = document.getElementById('p-id').value;
            const profile = {
                external_id: id,
                login: document.getElementById('p-login').value,
                dob: dToIso(document.getElementById('p-dob').value),
                work: dToIso(document.getElementById('p-work').value)
            };
            await supabase.from('profiles').upsert(profile, { onConflict: 'external_id' });
            localStorage.setItem('m_id', id);
            alert("Профиль сохранен!");
            show('menu-screen');
        }

        // --- ФИНАНСЫ ---
        async function updateAcc() {
            const id = localStorage.getItem('m_id');
            const { data } = await supabase.from('profiles').select('*').eq('external_id', id).maybeSingle();
            if(data) {
                document.getElementById('acc-sal').innerText = (data.salary || 0) + " CZK";
                document.getElementById('acc-czk').innerText = "-" + Math.abs(data.advCzk || 0) + " CZK";
                document.getElementById('acc-eur').innerText = "-" + Math.abs(data.advEur || 0) + " EUR";
                document.getElementById('acc-fin').innerText = "-" + Math.abs(data.fines || 0) + " CZK";
                
                const totalCzk = (data.salary || 0) - Math.abs(data.advCzk || 0) - Math.abs(data.fines || 0);
                document.getElementById('acc-total').innerText = `${totalCzk} CZK + ${Math.abs(data.advEur || 0)} EUR`;
            }
        }

        // --- ТОП ---
        async function loadTop(mode) {
            document.getElementById('t-adv').style.background = mode==='adv'?'var(--gold)':'transparent';
            document.getElementById('t-adv').style.color = mode==='adv'?'#000':'var(--gold)';
            document.getElementById('t-exp').style.background = mode==='exp'?'var(--gold)':'transparent';
            document.getElementById('t-exp').style.color = mode==='exp'?'#000':'var(--gold)';

            const table = document.getElementById('top-list');
            table.innerHTML = "<tr><td>Загрузка...</td></tr>";
            
            const { data } = await supabase.from('profiles').select('*');
            table.innerHTML = "";

            if(mode === 'adv') {
                table.innerHTML = "<tr><th>Имя</th><th>CZK</th><th>EUR</th></tr>";
                data.sort((a,b) => (Math.abs(b.advCzk)+Math.abs(b.advEur)*25) - (Math.abs(a.advCzk)+Math.abs(a.advEur)*25))
                    .forEach(u => table.innerHTML += `<tr><td>${u.login||'---'}</td><td>${Math.abs(u.advCzk||0)}</td><td>${Math.abs(u.advEur||0)}</td></tr>`);
            } else {
                table.innerHTML = "<tr><th>Имя</th><th>Дни стажа</th></tr>";
                const now = new Date();
                data.map(u => {
                    const start = new Date(u.work);
                    const diff = !isNaN(start) ? Math.floor((now - start)/(1000*60*60*24)) : 0;
                    return {...u, days: diff > 0 ? diff : 0};
                }).sort((a,b) => b.days - a.days)
                  .forEach(u => table.innerHTML += `<tr><td>${u.login||'---'}</td><td style="color:var(--gold); font-weight:bold;">${u.days} д.</td></tr>`);
            }
        }

        // --- ТАБЛИЦА ЧАСОВ ---
        function createGrid() {
            const b = document.getElementById('h-body'); b.innerHTML = "";
            for(let i=1; i<=31; i++) {
                b.innerHTML += `<tr>
                    <td>${i}</td>
                    <td><input type="number" class="h-input h-from" oninput="calcH(this)"></td>
                    <td><input type="number" class="h-input h-to" oninput="calcH(this)"></td>
                    <td class="h-row-res">0</td>
                    <td><input type="text" class="obj-input"></td>
                </tr>`;
            }
        }

        function calcH(el) {
            const tr = el.closest('tr');
            const f = parseFloat(tr.querySelector('.h-from').value) || 0;
            const t = parseFloat(tr.querySelector('.h-to').value) || 0;
            const res = t > f ? (t - f - 0.5) : 0;
            tr.querySelector('.h-row-res').innerText = res > 0 ? res : 0;
            let sum = 0; document.querySelectorAll('.h-row-res').forEach(td => sum += parseFloat(td.innerText)||0);
            document.getElementById('h-sum').innerText = sum;
        }

        async function openFirm(f) {
            activeFirm = f;
            document.getElementById('h-title').innerText = f.toUpperCase();
            const cache = JSON.parse(localStorage.getItem('h_'+f)) || [];
            const rows = document.querySelectorAll('#h-body tr');
            rows.forEach((r, i) => {
                if(cache[i]) {
                    r.querySelector('.h-from').value = cache[i].f;
                    r.querySelector('.h-to').value = cache[i].t;
                    r.querySelector('.h-row-res').innerText = cache[i].h;
                    r.querySelector('.obj-input').value = cache[i].o;
                } else {
                    r.querySelector('.h-from').value = ""; r.querySelector('.h-to').value = "";
                    r.querySelector('.h-row-res').innerText = "0"; r.querySelector('.obj-input').value = "";
                }
            });
            let sum = 0; document.querySelectorAll('.h-row-res').forEach(td => sum += parseFloat(td.innerText)||0);
            document.getElementById('h-sum').innerText = sum;
            show('hours-screen');
        }

        function saveHours(send) {
            const data = Array.from(document.querySelectorAll('#h-body tr')).map(r => ({
                f: r.querySelector('.h-from').value,
                t: r.querySelector('.h-to').value,
                h: r.querySelector('.h-row-res').innerText,
                o: r.querySelector('.obj-input').value
            }));
            localStorage.setItem('h_'+activeFirm, JSON.stringify(data));
            if(send) {
                alert("Отчет по фирме " + activeFirm + " отправлен!");
                localStorage.removeItem('h_'+activeFirm);
                createGrid(); show('clocks-screen');
            } else { alert("Данные сохранены!"); }
        }

        document.getElementById('h-reset').onclick = () => {
            if(confirm("Очистить таблицу?")) { localStorage.removeItem('h_'+activeFirm); createGrid(); document.getElementById('h-sum').innerText = "0"; }
        };

        // --- ФИРМЫ ---
        function renderFirms() {
            const cont = document.getElementById('firm-list');
            cont.innerHTML = firms.map(f => `<div class="row"><span>${f}</span><button class="btn-gold" style="width:auto; padding:5px 10px;" onclick="openFirm('${f}')">Выбрать</button></div>`).join('');
            localStorage.setItem('m_firms', JSON.stringify(firms));
        }
        function addFirm() { const n = prompt("Название:"); if(n) {firms.push(n); renderFirms();} }

        // --- ЗАПРОСЫ ---
        async function sendReq(table) {
            const id = localStorage.getItem('m_id');
            if(!id) return alert("Заполните профиль!");
            const payload = table === 'advances' ? {
                user_id: id, amount: document.getElementById('adv-sum').value,
                currency: document.getElementById('adv-val').value, reason: document.getElementById('adv-txt').value
            } : {
                user_id: id, date: dToIso(document.getElementById('do-date').value), reason: document.getElementById('do-txt').value
            };
            await supabase.from(table).insert([payload]);
            alert("Отправлено!"); show('menu-screen');
        }

        // --- КНОПКИ ---
        document.getElementById('go-profile').onclick = () => show('profile-screen');
        document.getElementById('btn-advances').onclick = () => show('advances-screen');
        document.getElementById('btn-clocks').onclick = () => show('clocks-screen');
        document.getElementById('btn-account').onclick = () => show('account-screen');
        document.getElementById('btn-dayoff').onclick = () => show('dayoff-screen');
        document.getElementById('btn-top').onclick = () => show('top-screen');
        document.getElementById('btn-shop').onclick = () => alert('Магазин в разработке');

        window.onload = init;
    </script>
</body>
</html>
