<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Monek System v4.3</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --gold: #ffcc33;
            --gold-gradient: linear-gradient(180deg, #ffcc33 0%, #ff9900 100%);
            --dark-overlay: rgba(10, 10, 10, 0.96);
            --bg-main: url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/BEE1273C-8A49-4B01-B2D5-31E01244A38C.png');
            --bg-loader: url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/DE0BFEBD-58A8-4CA4-A803-10BDD5E177A2.png');
            --bg-menu: url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/F4AAC9F1-4AFA-411A-8D97-82C5F86FE825.png');
            --bg-hours: url('https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/2A2B5DCA-E3CC-4307-AA90-BEC512A1BC8A.png');
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; }
        input { -webkit-user-select: text; user-select: text; }
        body, html { width: 100%; height: 100%; background-color: #000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; }

        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1; }
        .canvas { position: relative; width: 100%; height: 100%; background-size: 100% 100%; background-position: center top; background-repeat: no-repeat; display: flex; flex-direction: column; align-items: center; }

        #loader-screen .canvas { background-image: var(--bg-loader); }
        #menu-screen .canvas { background-image: var(--bg-menu); }
        #hours-screen .canvas { background-image: var(--bg-hours); }
        .canvas-bg-main { background-image: var(--bg-main) !important; }

        /* Лоадер */
        .loader-content { position: absolute; top: 46%; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .progress-container { width: 60%; height: 14px; background: rgba(0,0,0,0.6); border-radius: 20px; border: 2px solid rgba(255,255,255,0.4); overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ffcc33, #ff6600); }
        #loading-text { color: var(--gold); font-size: 20px; margin-top: 12px; font-weight: 900; -webkit-text-stroke: 1.2px black; }

        .header-logo { width: 210px; margin-top: 15px; pointer-events: none; }

        /* ГЛАВНАЯ СЕТКА (ПОДНЯТА И УМЕНЬШЕНА) */
        .menu-grid {
            position: absolute;
            top: 37%;           /* Высота панели */
            width: 80%;         /* Ширина всей панели */
            height: 46%;        /* Высота всей панели */
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, 1fr);
            gap: 12px;
        }

        .menu-item { display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .menu-icon { width: 85%; height: auto; max-height: 90%; object-fit: contain; transition: transform 0.1s; }
        .menu-item:active .menu-icon { transform: scale(0.92); }

        /* ПАНЕЛИ И ФУНКЦИОНАЛ */
        .panel-container { 
            width: 82%; 
            background: var(--dark-overlay); 
            border: 1px solid var(--gold); 
            border-radius: 12px; 
            padding: 18px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.9);
            margin-top: 55%; /* Центрирование панелей относительно фона */
        }

        .panel-title { color: var(--gold); font-weight: 900; text-transform: uppercase; margin-bottom: 15px; font-size: 14px; letter-spacing: 1px; }
        .panel-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid rgba(255,204,51,0.4); background: rgba(0,0,0,0.3); color: white; border-radius: 8px; text-align: center; font-size: 14px; }
        
        .btn-panel { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; font-weight: 900; text-transform: uppercase; font-size: 13px; cursor: pointer; border: none; }
        .btn-panel-gold { background: var(--gold-gradient); color: #000; }
        .btn-panel-outline { background: transparent; border: 1px solid var(--gold); color: var(--gold); }

        /* Таблицы и Списки */
        .scroll-box { width: 100%; max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 10px; }
        .stat-row { display: flex; justify-content: space-between; width: 100%; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .stat-label { color: #aaa; font-size: 12px; }
        .stat-value { color: var(--gold); font-weight: bold; font-size: 12px; }

        /* Часы (фирмы) */
        .hours-unified-panel { width: 90%; margin-top: 15%; background: var(--dark-overlay); border: 2px solid var(--gold); border-radius: 15px; overflow: hidden; }
        .hours-table-main { width: 100%; border-collapse: collapse; color: white; font-size: 12px; }
        .hours-table-main th { position: sticky; top: 0; background: var(--gold); color: black; padding: 10px 2px; }
        .hour-input-cell { width: 90%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,204,51,0.2); color: white; text-align: center; padding: 4px; border-radius: 4px; }

        .btn-round { width: 30px; height: 30px; border-radius: 50%; background: var(--gold); color: black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
    </style>
</head>
<body onclick="hideKeyboard(event)">

    <div id="loader-screen" class="screen" style="display: block;">
        <div class="canvas">
            <div class="loader-content">
                <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
                <div id="loading-text">0%</div>
            </div>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <div class="canvas">
            <div style="position:absolute; top:0; width:100%; display:flex; justify-content:center;">
                <img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/793A440C-0C46-4BAD-A352-8F31E47BB1D6.png" class="header-logo">
            </div>
            <div class="menu-grid">
                <div class="menu-item" onclick="showScreen('profile-screen')"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/D6D08605-797C-407A-AC9F-CA1D85241C3A.png" class="menu-icon"></div>
                <div class="menu-item" onclick="showScreen('clocks-screen')"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/8CF47A13-928B-47FC-9494-D6354E56BB25.png" class="menu-icon"></div>
                <div class="menu-item" onclick="showScreen('workers-screen')"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/F0374C7C-C546-4CF7-8BCD-3E8137BEC8EA.png" class="menu-icon"></div>
                <div class="menu-item" onclick="showScreen('top-screen')"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/1656CF23-37C3-4E2D-B9B5-7A86688E4DC0.png" class="menu-icon"></div>
                <div class="menu-item" onclick="showScreen('advances-screen')"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/9B30F657-53D7-4158-91D6-5F004D6E3D19.png" class="menu-icon"></div>
                <div class="menu-item" onclick="showScreen('account-screen')"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/96CCD0ED-D67B-4AD3-823E-35FD2BECCAB2.png" class="menu-icon"></div>
                <div class="menu-item" onclick="showScreen('shop-screen')"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/6E3CA577-B227-4A8B-9929-A020B6B6AF5C.png" class="menu-icon"></div>
                <div class="menu-item" onclick="showScreen('dayoff-screen')"><img src="https://raw.githubusercontent.com/cryptokakhnych/monek-system-v2/refs/heads/main/EBD0902B-4CCD-44C4-94FD-C5CF1E27F3F5.png" class="menu-icon"></div>
            </div>
        </div>
    </div>

    <div id="profile-screen" class="screen">
        <div class="canvas canvas-bg-main">
            <div class="panel-container">
                <div class="panel-title">Ваш Профиль</div>
                <input type="text" id="prof-login" class="panel-input" placeholder="Имя Фамилия">
                <input type="text" id="prof-dob" class="panel-input" placeholder="Дата рождения (ДД-ММ-ГГГГ)">
                <input type="text" id="prof-workdate" class="panel-input" placeholder="Начало работы (ДД-ММ-ГГГГ)">
                <input type="text" id="prof-id" class="panel-input" placeholder="Ваш ID">
                <button class="btn-panel btn-panel-gold" onclick="submitProfile()">СОХРАНИТЬ</button>
                <button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button>
            </div>
        </div>
    </div>

    <div id="account-screen" class="screen">
        <div class="canvas canvas-bg-main">
            <div class="panel-container">
                <div class="panel-title">Мой Счет</div>
                <div class="scroll-box" style="background:transparent; max-height:none;">
                    <div class="stat-row"><span class="stat-label">Зарплата:</span><span id="acc-salary" class="stat-value">0 CZK</span></div>
                    <div class="stat-row"><span class="stat-label">Авансы (CZK):</span><span id="acc-adv-czk" class="stat-value">0 CZK</span></div>
                    <div class="stat-row"><span class="stat-label">Авансы (EUR):</span><span id="acc-adv-eur" class="stat-value">0 EUR</span></div>
                    <div class="stat-row"><span class="stat-label">Штрафы:</span><span id="acc-fines" class="stat-value">0 CZK</span></div>
                </div>
                <div id="acc-total-payout" style="width:100%; padding:12px; margin-top:10px; background:rgba(255,204,51,0.15); border:1px dashed var(--gold); border-radius:8px; color:var(--gold); text-align:center; font-weight:bold; font-size:14px;">
                    ИТОГО: 0 CZK | 0 EUR
                </div>
                <button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button>
            </div>
        </div>
    </div>

    <div id="shop-screen" class="screen">
        <div class="canvas canvas-bg-main">
            <div class="panel-container">
                <div class="panel-title">Магазин</div>
                <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div><span style="color:var(--gold); font-size:14px;">Сахарок</span><br><span id="sugar-price" style="font-size:10px; color:#888;">200 CZK</span></div>
                    <input type="number" id="qty-sugar" class="panel-input" style="width:70px; margin:0;" placeholder="0" oninput="calculateShop()">
                </div>
                <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div><span style="color:var(--gold); font-size:14px;">Зеленая</span><br><span id="green-price" style="font-size:10px; color:#888;">150 CZK</span></div>
                    <input type="number" id="qty-green" class="panel-input" style="width:70px; margin:0;" placeholder="0" oninput="calculateShop()">
                </div>
                <div style="color:var(--gold); font-weight:bold; margin:10px 0;">ИТОГО: <span id="grand-total">0</span> CZK</div>
                <button class="btn-panel btn-panel-gold" onclick="submitShopOrder()">ЗАКАЗАТЬ</button>
                <button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button>
            </div>
        </div>
    </div>

    <div id="clocks-screen" class="screen">
        <div class="canvas canvas-bg-main">
            <div class="panel-container">
                <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div class="panel-title" style="margin:0;">Мои Фирмы</div>
                    <div style="display:flex; gap:10px;">
                        <div class="btn-round" onclick="addFirm()">+</div>
                        <div class="btn-round" id="btn-del-firm" onclick="toggleDeleteMode()">−</div>
                    </div>
                </div>
                <div id="firm-list-container" class="scroll-box" style="max-height:300px;"></div>
                <button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button>
            </div>
        </div>
    </div>

    <div id="hours-screen" class="screen">
        <div class="canvas">
            <div class="hours-unified-panel">
                <div style="padding:15px; text-align:center; border-bottom:1px solid var(--gold);">
                    <div id="current-firm-name" class="panel-title" style="margin:0">ФИРМА</div>
                </div>
                <div style="height:350px; overflow-y:auto;">
                    <table class="hours-table-main">
                        <thead><tr><th>Д</th><th>ОТ</th><th>ДО</th><th>Ч</th><th>ОБЪЕКТ</th></tr></thead>
                        <tbody id="hours-tbody"></tbody>
                    </table>
                </div>
                <div style="padding:15px; background:rgba(0,0,0,0.8); border-top:1px solid var(--gold);">
                    <div style="color:var(--gold); font-weight:bold; text-align:center; margin-bottom:10px;">ВСЕГО: <span id="table-total-val">0</span> Ч</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <button class="btn-panel btn-panel-gold" style="margin:0;" onclick="saveHoursData()">Сохранить</button>
                        <button class="btn-panel btn-panel-outline" style="margin:0; background:#f44336; border:none; color:white;" onclick="clearHoursData()">Очистить</button>
                        <button class="btn-panel btn-panel-gold" style="margin:0; background:#4CAF50; border:none; color:white; grid-column: span 2;" onclick="sendHoursReport()">Отправить Отчет</button>
                        <button class="btn-panel btn-panel-outline" style="margin:0; grid-column: span 2;" onclick="showScreen('clocks-screen')">Назад</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="advances-screen" class="screen"><div class="canvas canvas-bg-main"><div class="panel-container"><div class="panel-title">Запрос Аванса</div><select id="adv-currency" class="panel-input"><option value="CZK">CZK</option><option value="EUR">EUR</option></select><input type="number" id="adv-amount" class="panel-input" placeholder="Сумма"><input type="text" id="adv-reason" class="panel-input" placeholder="Причина"><button class="btn-panel btn-panel-gold" onclick="submitAdvances()">ОТПРАВИТЬ</button><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>
    <div id="dayoff-screen" class="screen"><div class="canvas canvas-bg-main"><div class="panel-container"><div class="panel-title">Выходной</div><input type="text" id="dayoff-date" class="panel-input" placeholder="Дата (ДД.ММ)"><input type="text" id="dayoff-reason" class="panel-input" placeholder="Причина"><button class="btn-panel btn-panel-gold" onclick="submitDayOff()">ОТПРАВИТЬ</button><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>
    <div id="top-screen" class="screen"><div class="canvas canvas-bg-main"><div class="panel-container"><div class="panel-title">Рейтинг</div><div id="top-list" class="scroll-box"></div><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>
    <div id="workers-screen" class="screen"><div class="canvas canvas-bg-main"><div class="panel-container"><div class="panel-title">Сотрудники</div><div id="workers-list" class="scroll-box"></div><button class="btn-panel btn-panel-outline" onclick="backToMenu()">НАЗАД</button></div></div></div>

    <script>
        const SUPABASE_URL = 'https://mnexoturnujxjjicfukc.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uZXhvdHVybnVqeGpqaWNmdWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MTY1MzksImV4cCI6MjA4NTA5MjUzOX0.Ye4PJuEpuyLLRACkv72tvf0mh7IBn7JYRA8OJ1kLrc0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let firms = JSON.parse(localStorage.getItem('monek_firms')) || ["Monek Group"];
        let isDelMode = false;
        let dbUsers = [];

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'account-screen') fetchAccountData();
            if(id === 'workers-screen') renderWorkers();
            if(id === 'top-screen') renderTop();
        }

        function backToMenu() { showScreen('menu-screen'); }

        async function init() {
            renderFirms();
            generateHoursTable();
            loadProfile();
            const bar = document.getElementById('progress-bar');
            let p = 0;
            const iv = setInterval(() => {
                p += 5; bar.style.width = p+'%'; document.getElementById('loading-text').innerText = p+'%';
                if(p>=100) { clearInterval(iv); showScreen('menu-screen'); }
            }, 50);
        }

        // --- ЛОГИКА АККАУНТА (ОТРИЦАТЕЛЬНЫЕ АВАНСЫ) ---
        async function fetchAccountData() {
            const id = localStorage.getItem('last_id');
            if(!id) return;
            const { data } = await supabaseClient.from('profiles').select('*').eq('external_id', id).maybeSingle();
            if(data) {
                const czkAdv = data.advCzk > 0 ? -data.advCzk : data.advCzk;
                const eurAdv = data.advEur > 0 ? -data.advEur : data.advEur;
                document.getElementById('acc-salary').innerText = data.salary + " CZK";
                document.getElementById('acc-adv-czk').innerText = czkAdv + " CZK";
                document.getElementById('acc-adv-eur').innerText = eurAdv + " EUR";
                document.getElementById('acc-fines').innerText = (data.fines || 0) + " CZK";
                document.getElementById('acc-total-payout').innerText = `ИТОГО: ${data.salary + czkAdv + (data.fines||0)} CZK | ${eurAdv} EUR`;
            }
        }

        // --- ФИРМЫ И ЧАСЫ ---
        function renderFirms() {
            const container = document.getElementById('firm-list-container');
            container.innerHTML = '';
            firms.forEach((f, i) => {
                const row = document.createElement('div');
                row.className = 'stat-row';
                row.innerHTML = `<span style="color:white">${f}</span>`;
                const btn = document.createElement('button');
                if(isDelMode) {
                    btn.innerText = 'УДАЛИТЬ'; btn.className = 'btn-panel-outline'; btn.style.width='auto'; btn.style.padding='4px 8px';
                    btn.onclick = () => { firms.splice(i,1); renderFirms(); };
                } else {
                    btn.innerText = 'ВЫБРАТЬ'; btn.className = 'btn-panel-gold'; btn.style.width='auto'; btn.style.padding='4px 8px';
                    btn.onclick = () => openHoursTable(f);
                }
                row.appendChild(btn); container.appendChild(row);
            });
            localStorage.setItem('monek_firms', JSON.stringify(firms));
        }

        function addFirm() { let n = prompt("Название фирмы:"); if(n) { firms.push(n); renderFirms(); } }
        function toggleDeleteMode() { isDelMode = !isDelMode; document.getElementById('btn-del-firm').style.background = isDelMode ? 'red' : ''; renderFirms(); }

        let activeFirm = "";
        function openHoursTable(f) {
            activeFirm = f;
            document.getElementById('current-firm-name').innerText = f;
            loadHoursForFirm(f);
            showScreen('hours-screen');
        }

        function generateHoursTable() {
            const tbody = document.getElementById('hours-tbody');
            tbody.innerHTML = '';
            for(let i=1; i<=31; i++) {
                tbody.innerHTML += `<tr>
                    <td style="padding:10px 5px">${i}</td>
                    <td><input type="number" class="hour-input-cell inp-from" oninput="calcRow(this)"></td>
                    <td><input type="number" class="hour-input-cell inp-to" oninput="calcRow(this)"></td>
                    <td class="row-res">0</td>
                    <td><input type="text" class="hour-input-cell inp-obj"></td>
                </tr>`;
            }
        }

        function calcRow(el) {
            const tr = el.closest('tr');
            const f = parseFloat(tr.querySelector('.inp-from').value);
            const t = parseFloat(tr.querySelector('.inp-to').value);
            const res = tr.querySelector('.row-res');
            if(f && t && t > f) {
                let h = (t - f) - 0.5;
                res.innerText = h > 0 ? h : 0;
            } else res.innerText = 0;
            updateTotalHours();
        }

        function updateTotalHours() {
            let total = 0;
            document.querySelectorAll('.row-res').forEach(td => total += parseFloat(td.innerText)||0);
            document.getElementById('table-total-val').innerText = total;
        }

        function saveHoursData() {
            const rows = Array.from(document.querySelectorAll('#hours-tbody tr')).map(tr => ({
                f: tr.querySelector('.inp-from').value,
                t: tr.querySelector('.inp-to').value,
                h: tr.querySelector('.row-res').innerText,
                o: tr.querySelector('.inp-obj').value
            }));
            localStorage.setItem('hours_' + activeFirm, JSON.stringify(rows));
            alert("Данные сохранены локально");
        }

        function loadHoursForFirm(f) {
            const data = JSON.parse(localStorage.getItem('hours_' + f)) || [];
            const rows = document.querySelectorAll('#hours-tbody tr');
            rows.forEach((tr, i) => {
                if(data[i]) {
                    tr.querySelector('.inp-from').value = data[i].f;
                    tr.querySelector('.inp-to').value = data[i].t;
                    tr.querySelector('.row-res').innerText = data[i].h;
                    tr.querySelector('.inp-obj').value = data[i].o;
                } else {
                    tr.querySelector('.inp-from').value = ''; tr.querySelector('.inp-to').value = ''; tr.querySelector('.row-res').innerText = '0'; tr.querySelector('.inp-obj').value = '';
                }
            });
            updateTotalHours();
        }

        function clearHoursData() { if(confirm("Очистить таблицу?")) { localStorage.removeItem('hours_'+activeFirm); loadHoursForFirm(activeFirm); } }

        async function sendHoursReport() {
            alert("Отчет отправлен в систему!");
            localStorage.removeItem('hours_'+activeFirm);
            showScreen('clocks-screen');
        }

        // --- ПРОФИЛЬ ---
        async function submitProfile() {
            const p = {
                login: document.getElementById('prof-login').value,
                external_id: document.getElementById('prof-id').value,
                work: document.getElementById('prof-workdate').value,
                dob: document.getElementById('prof-dob').value
            };
            localStorage.setItem('last_id', p.external_id);
            await supabaseClient.from('profiles').upsert([p], { onConflict: 'external_id' });
            alert("Профиль сохранен!");
            backToMenu();
        }

        function loadProfile() {
            const id = localStorage.getItem('last_id');
            if(id) document.getElementById('prof-id').value = id;
        }

        function calculateShop() {
            const s = (parseInt(document.getElementById('qty-sugar').value)||0)*200;
            const g = (parseInt(document.getElementById('qty-green').value)||0)*150;
            document.getElementById('grand-total').innerText = s + g;
        }

        function submitShopOrder() { alert("Заказ принят!"); backToMenu(); }
        function hideKeyboard(e) { if(e.target.tagName !== 'INPUT') document.activeElement.blur(); }

        window.onload = init;
    </script>
</body>
</html>
